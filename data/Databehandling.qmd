---
title: "Masteroppgave"
author: 
  "Kevin Ha"
  "Ola Andre Olofsson"
format: html
editor: visual
editor_options:
  chunk_output_type: console
---

# Setup Chunk

```{r setup_base}
library(readr)
library(readxl)
library(tidyverse)
library(dplyr)
library(openxlsx)
library(lubridate)
library(zoo)
library(sf)
library(sp)
library(tmap)
library(magrittr)
library(measurements)
options(paged.print = FALSE)
```

# Databehandling - Rådata, ENOVA

```{r}
# Kevin: Lagt inn suppressWarnings() for å slippe masse spam/warnings

Energi_2010_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2010.csv"))
Energi_2011_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2011.csv"))
Energi_2012_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2012.csv"))
Energi_2013_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2013.csv"))
Energi_2014_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2014.csv"))
Energi_2015_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2015.csv"))
Energi_2016_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2016.csv"))
Energi_2017_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2017.csv"))
Energi_2018_Vestland <- suppressWarnings(read_csv("data/Energikarakterer_2018.csv"))
Energi_2019_Vestland <- suppressWarnings(read_excel("data/Energikarakterer_2019.xlsx"))
Energi_2020_Vestland <- suppressWarnings(read_excel("data/Energikarakterer_2020.xlsx"))
Energi_2021_Vestland <- suppressWarnings(read_excel("data/Energikarakterer_2021.xlsx"))
Energi_2022_Vestland <- suppressWarnings(read_excel("data/Energikarakterer_2022.xlsx"))
```

```{r}
Energi_2010_Vestland <- Energi_2010_Vestland[Energi_2010_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2011_Vestland <- Energi_2011_Vestland[Energi_2011_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2012_Vestland <- Energi_2012_Vestland[Energi_2012_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2013_Vestland <- Energi_2013_Vestland[Energi_2013_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2014_Vestland <- Energi_2014_Vestland[Energi_2014_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2015_Vestland <- Energi_2015_Vestland[Energi_2015_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2016_Vestland <- Energi_2016_Vestland[Energi_2016_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2017_Vestland <- Energi_2017_Vestland[Energi_2017_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2018_Vestland <- Energi_2018_Vestland[Energi_2018_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)
```

## Sammenslår datasett, fom. 2019 tom. 2022

```{r}
ENOVA_Vestland <- rbind(
  Energi_2010_Vestland,
  Energi_2011_Vestland,
  Energi_2012_Vestland,
  Energi_2013_Vestland,
  Energi_2014_Vestland,
  Energi_2015_Vestland,
  Energi_2016_Vestland,
  Energi_2017_Vestland,
  Energi_2018_Vestland,
  Energi_2019_Vestland,
  Energi_2020_Vestland,
  Energi_2021_Vestland,
  Energi_2022_Vestland) %>% 
  select(
    -EnergiVurderingDato,
    -BeregnetFossilandel,
    -Attestnummer,
    -HarEnergiVurdering)
```

## Fjerner rekker observasjoner med organisasjonsnummer

Vi velger å fjerne rekkene med organisasjonsnummer da dette er boliger eid og kjøpt av næringer. Vi er i denne oppgaven interesert i hvordan det i hovedsak påvirker private, og boliger med organisasjonsnummer blir dermed en verdi vi ikke har behov for.

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  filter(is.na(Organisasjonsnummer))
```

## Fjerner nå kolonnen for organisasjonsnummer

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  select(-Organisasjonsnummer, -Poststed)
```

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
   select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

### Fjerner individuelle datasett fra ENOVA

```{r}
rm(Energi_2010_Vestland)
rm(Energi_2011_Vestland)
rm(Energi_2012_Vestland)
rm(Energi_2013_Vestland)
rm(Energi_2014_Vestland)
rm(Energi_2015_Vestland)
rm(Energi_2016_Vestland)
rm(Energi_2017_Vestland)
rm(Energi_2018_Vestland)
rm(Energi_2019_Vestland)
rm(Energi_2020_Vestland)
rm(Energi_2021_Vestland)
rm(Energi_2022_Vestland)
```

# Databehandling - Rådata, Eiendomsverdi AS

```{r}
EV <- read_excel("data/EV_kommaseparert.xlsx") %>% 
  select(-CityDistrict)
```

# Boligkoordinater

## Leser inn filen for boligkoordinater

```{r}
KoordinaterVestland <- read_delim("data/KoordinaterVestland.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
```

## Filterer ut relevante kommuner

```{r}
KoordinaterVestland <- KoordinaterVestland[KoordinaterVestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
```

## Slår sammen på koordinater for boliger med ENOVA_Vestland

```{r}
KoordinaterVestland <- KoordinaterVestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

```{r}
merged_data <- inner_join(ENOVA_Vestland, KoordinaterVestland, by = "Matrikkelnummer")
```

```{r}
ENOVA_coords <- distinct(merged_data, GateAdresse, .keep_all = TRUE)
```

```{r}
ENOVA_coords <- ENOVA_coords %>%
  unite(col = "Matrikkel", c("Matrikkelnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Matrikkelnummer, 
         -Snr, 
         -Postnummer, 
         -Utstedelsesdato, 
         -TypeRegistrering, 
         -Fnr)
```

### Rydder vekk fullstendige datasett, for kontroll og unngå å rote.

```{r}
rm(merged_data)
rm(KoordinaterVestland)
```

## Fjerner snr fra ENOVA_Vestland

```{r}
# ENOVA_Vestland <- ENOVA_Vestland %>% 
  # select(-Snr)
```

# Koordinater, Bergen

```{r}
Bergen <- data.frame(
  id = 1,
  lat = 6734324.253425,
  long = -32030.264488
)
```

### Ting å gjøre her:

Finne en ID vi kan bruke til å kombinere med ENOVA_Vestland/ENOVA_coords Kan henda me må laga ein eigen ID i Vestland_coords & Bergen datasettet, f.eks. ein nummerisk ID som me kan utnytta te å slå sammen desse to på? Finne ut vilken format (CRS/EPSG) vi skal bruke på dette Transponere datasettene

Mutate en felles koordinat (Lengde og bredde) for ENOVA_Vestland Mutate en felles koordinat (Lengde og bredde) for Bergen Bruke st_distance for å finne avstand i luftlinje mellom punktene for å finne distanste mellom sentrum og boliger Sjekke og evt. konvertere til rett måleformat (km)

# Databehandling - Ambita

Opprinnelig datasett inneholder 284 340 obs. of 121 variables, så før innlasting er det i Excel fjernet:

-   45 variabler

-   224 996 obs.

# Databehandling Ambita AS

```{r}
#Ambita <- read_excel("Ambita.xlsx")
Ambita <- read_excel("data/Ambita_Delvis.xlsx")
Ambita_Oppdatert <- read_excel("data/Ambita_Delvis_Oppdatert.xlsx")
```

```{r}
Ambita <- Ambita[Ambita$DokumentAr %in% c(2019, 2020, 2021, 2022), ]
```

## Tar vekk kolonner som ikke er relevante for oss

### Hovedvariabler som ikke er nødvendige

```{r}
Ambita <- Ambita %>% 
  select(-InternidDokument,
         -Embetenr,
         -InternidRettsstiftelse,
         -Rettsstiftelsesnr,
         -Rettsstiftelsestypekode,
         -Rettsstiftelsestype,
         -AvgiftsGrunnlag,
         -AvgiftsAarsakkode,
         -AvgiftsAarsak,
         -Omsetningstypekode,
         -Anvendelseskode,
         -Boligtypekode,
         -AndelOmsatt,
         -FormalBoligseksjon,
         -OrganisasjonSomEier,
         -EtablertDato,
         -AdresseEier,
         -AndelTeller,
         -AndelNevner,
         -AndelStatus,
         -EiendomAdressegatenr,
         -Postnr,
         -Poststed,
         -BygningstypeKode,
         -Naeringsgruppekode,
         -Tattibrukdato,
         -Dokumenttypekode,
         -Dokumenttype,
         -InternidEiendom,
         -Festenr,
         -PromSKD,
         -KvmPrisSKD,
         -LigningsverdiSKD,
         -EiendomHoyde,
         -ObjektNivakode,
         -ObjektNiva,
         -AnonymIDEier,
         -PersonIDTypeKodeEier,
         -PersonIDTypeEier,
         -NavnEier,
         -BolignrEier,
         -DSFStatusKodeEier,
         -DSFStatusEier,
         -KjonnEier,
         -AlderEier,
         -InternidAdresse,
         -Bydel,
         -Bydelsnr,
         -Grunnkretsnr,
         -Grunnkrets,
         -AdresseHoyde,
         -InternidBygning,
         #-InternIdBruksenhet,
         -Etasjekode,
         -Kjokkentypekode)
```

### Tar vekk variabler, men med mer forsiktighet

```{r}
Ambita <- Ambita %>% 
  select(-AdresseNordSor,
         -AdresseOstVest,
         -ID_MATRIKKELEN_EIENDOM,
         -ID_MATRIKKELEN_ADRESSE,
         -ID_MATRIKKELEN_BRUKSENHET,
         -ID_MATRIKKELEN_BYGNING)
```

## Endrer kolonne navn

```{r}
colnames(Ambita)[colnames(Ambita) == "Kommunenr"] <- "Knr"
colnames(Ambita)[colnames(Ambita) == "Gardsnr"] <- "Gnr"
colnames(Ambita)[colnames(Ambita) == "Bruksnr"] <- "Bnr"
colnames(Ambita)[colnames(Ambita) == "Seksjonsnr"] <- "Snr"
colnames(Ambita)[colnames(Ambita) == "Andelsnr"] <- "Andelsnummer"
colnames(Ambita)[colnames(Ambita) == "Bygningsnr"] <- "Bygningsnummer"
```

```{r}
# Her endrer vi alle Snr og Andelsnummer fra 0 til NA slik at det blir identisk som i ENOVA sitt datasett
Ambita$Snr[Ambita$Snr == 0] <- NA
Ambita$Andelsnummer[Ambita$Andelsnummer == 0] <- NA
```

```{r}
Ambita <- Ambita %>%
  unite(col = "Matrikkel", c("Knr", "Gnr", "Bnr", "Andelsnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Snr, -Andelsnummer)
```

## Slår Sammen Ambita og ENOVA_coords

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  unite(col = "Matrikkel", c("Matrikkelnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Matrikkelnummer, -Snr)
```

Vi skal slå sammen datasettene ENOVA_Vestland med Ambita med hensyn på Matrikkel.

Det vi ønsker er å slå sammen datasettene på matrikkel, og utelukke alle verdier som ikke matcher på matrikkel i disse to datasettene.

Vi har prøvd mye rundt funksjonene - inner_join - merge - left_join

Vi kommer oss ikke videre herifra. Vi har også prøvd å slå sammen på bolignummer, men får at det er to ulike kolonnetyper, hvor den ene er double og den andre er characters.

```{r}
tmp <- merge(Ambita, ENOVA_Vestland, by = "Matrikkel", all.x = TRUE, all.y = TRUE)
```

```{r}
#Tmp2 <- distinct(tmp, Bygningsnummer.x)
```

```{r}
#unique(Tmp2)
```

.keep_all = TRUE

```{r}
#Test <- Ambita %>% 
#  left_join(ENOVA_Vestland,
#            by = c("Matrikkel" = "Matrikkel")
#            )
```

```{r}
#duplikat <- Test[duplicated(Test$Matrikkel),]
#print(duplikat)
```

```{r}
#distinct(Test)
```

```{r}
#Sammen <- merge(ENOVA_Vestland, Ambita, by = "Bygningsnummer")
```

```{r}
#Datasett <- distinct(Sammen, GateAdresse, .keep_all = TRUE)
```

Jeg vil foreslå å splitte Matrikkel opp i knr (kommune nummer), gnr (gårdsnummer), bnr (bruksnummer), snr (seksjonsnummer) og fnr (festenummer). For de to siste er jeg usikker på rekkefølgen, men dere har kansje dokumentasjon på Matrikkelnummeret. Hvis jeg har gjettet feil må dere bytte om på snr og fnr.

```{r}
# starter med ENOVA_vestland
# fikk feilmelding fra separate_wider_delim() om at det var 3 obs. med mer
# 5 verdier. Derfor too_many = "debug"
tmp <- ENOVA_Vestland |> 
  # ny funksjon erstatter separate()
  separate_wider_delim(
    cols = Matrikkel,
    delim = "/",
    names = c("knr", "gnr", "bnr", "snr", "fnr"),
    too_many = "debug"
  )
```

Finner de 3

```{r}
tmp |> filter(Matrikkel_ok == FALSE) |> select(c(gnr:bnr), Matrikkel) 
```

Ser at diise tre har seks verdier, der den siste er NA for alle tre. Antar at denne NA verdien er feil. Kan enten droppe de tre obs. eller rette. Retter ved å legge de tre ut i tmp1. Redigerer så Matrikkel for de tre (fjerner /NA).

```{r}
tmp1 <- ENOVA_Vestland |> filter(Matrikkel %in% c("4601/97/93/110/12/NA", "4601/160/797/30/492/NA", "4601/24/10/039/006/NA"))
# not 6 parts
tmp2 <- ENOVA_Vestland |> filter(!Matrikkel %in% c("4601/97/93/110/12/NA", "4601/160/797/30/492/NA", "4601/24/10/039/006/NA"))
```

```{r}
tmp1[,1:3]
```

```{r}
tmp1[1, "Matrikkel"] <- "4601/97/93/110/12"
tmp1[2, "Matrikkel"] <- "4601/160/797/30/492"
tmp1[3, "Matrikkel"] <- "4601/24/10/039/006"
```

Oppdatert ENOVA_Vestland

```{r}
ENOVA_Vestland <- bind_rows(tmp1, tmp2)
```

```{r}
# rydder
rm(tmp,
   tmp1,
   tmp2)
```

```{r}
# splitter Matrikkel
ENOVA_Vestland <- ENOVA_Vestland |> 
  # ny funksjon erstatter separate()
  separate_wider_delim(
    cols = Matrikkel,
    delim = "/",
    names = c("knr", "gnr", "bnr", "snr", "fnr")
  )
```

```{r}
# splitter Matrikkel i Ambita
Ambita <- Ambita |> 
  # ny funksjon erstatter separate()
  separate_wider_delim(
    cols = Matrikkel,
    delim = "/",
    names = c("knr", "gnr", "bnr", "snr", "fnr")
  )
```

Ser at ENOVA_Vestland har en variabel Utstedelsesdato som har noe å gjøre med når et tiltak er gjennomført. Ser tilsvarende at Ambita har en DokumentDato variabel som jeg antar er datoen eierskifte blir tinglyst og at Kjøpesum er salgssummen relatert til dette eierskifte. Vil anta at en del av boligene kan være solgt på flere tidspunkt. D avil det være slik at når en slår sammen de to datasettene vil en kunne få flere observasjoner fordi samme bolig i ENOVA_Vestland har blitt tingslyst flere ganger. Dere vil antakelig kunne bruke dataovariablene der en har multiple salg til å finne verdi før og etter at ENOVA tiltak er gjennoført.

```{r}
# Endrer Ambita variabelen Bygningsnummer fra numeric til character
# nødvendig for join nedenfor
Ambita$Bygningsnummer <- as.character(Ambita$Bygningsnummer)
```

```{r}
EnAmb <- ENOVA_Vestland |> 
  left_join(
    y = Ambita,
    by = c("Bygningsnummer", "knr", "gnr", "bnr")
  )
```

Ser at EnAmb har 13884 observasjoner (mot 3067 i ENOVA_Vestland). Noe av veksten i antall obs. kan skyldes multiple salg, noe kan skyldes at objektene ikke er entydig definert vha. Bygningsnummer, knr, gnr, bnr. Typisk problem med boligblokker, borettslag og seksjonerte eiendommer.

Dere har postaddresse både i ENOVA_Vestland og Ambita. I Ambita er postadressen splittet i varaiablene EiendomAdressegatenavn, EiendomAdressehusnr og EiendomAdressebokstav. I ENOVA_Vestland er dette kombinert i variabelen GateAdresse. Dere kan prøve å splitte også denne opp i variablene EiendomAdressegatenavn, EiendomAdressehusnr og EiendomAdressebokstav. Da vil dere få anledning til også å matche på adresse.

Dere må nok bruke regexp (se r4ds.had.co.nz cap. 14 særlig 14.3) og også andre funksjoner fra str\_ for å få alt på samme form (bruk av hhv. stor og liten bokstav). Dette er en kjekk liten utfordring ;-)

Her er en start.

```{r}
# Fikser først GateAdresse, noen uten mellomrom mellom navn og nummer
tmp <- ENOVA_Vestland$GateAdresse |> 
      str_match(
        pattern = "^([^\\d]*)(\\d+)\\s*\\w?"
        )

ENOVA_Vestland$GateAdresse <- paste(tmp[,2], tmp[,3])
rm(tmp)
```

```{r}
ENOVA_Vestland <- ENOVA_Vestland |> 
  mutate(
    EiendomAdressegatenavn =  str_extract(
      GateAdresse,
      pattern = "(.+)\\s+(\\d+)\\s?(\\w?)$",
      group = 1
    ),
    EiendomAdressehusnr =  str_extract(
      GateAdresse,
      pattern = "(.+)\\s+(\\d+)\\s?(\\w?)$",
      group = 2
    ),
    EiendomAdressebokstav =  str_extract(
      GateAdresse,
      pattern = "(.+)\\s+(\\d+)\\s?(\\w?)$",
      group = 3
    ),
    .after = GateAdresse
  )
```

Kanskje en idé å downcase EiendomAdressegatenavn i både ENOVA_Vestland og Ambita og også å bruke str_replace() for å bytte ut mellomrom med \_ for letter å se mellomrom tegn som er lagt inn.

Nå kan dere kanskje også matche på adresse.

## Fikser Gatenavn til små bokstaver

```{r}
EnAmb <- EnAmb %>%
  mutate(EiendomAdressegatenavn = tolower(EiendomAdressegatenavn))
```

## Filterer ut NA-verdier fra DokumentAr

```{r}
EnAmb <- drop_na(EnAmb, DokumentAr) %>% 
  select(-DokumentAr)
```

```{r}
Data_Analyse_1 <- distinct(EnAmb, Dokumentnr, .keep_all = TRUE) %>% 
  select(-Dokumentnr)
```

```{r}
Data_Analyse_2 <- distinct(Data_Analyse_1, InternIdBruksenhet, .keep_all = TRUE) %>% 
  select(-InternIdBruksenhet)
```

```{r}
#Data_Analyse_3 <- distinct(EnAmb, InternIdBruksenhet, .keep_all = TRUE) %>% 
  #select(-InternIdBruksenhet)
```

# Leser inn modifisert datasett fra Excell

```{r}
Datasett_Rensket <- suppressWarnings(read_excel("data/Datasett_Rensket.xlsx"))
```

## Filtrerer ut salgsverdier under 1 million kroner

```{r}
Datasett_Rensket <- Datasett_Rensket %>% 
  filter(Kjopesum >= 1000000)
```

## Rydder i kolonner

### Nytt navn på matrikkel

```{r}
colnames(Datasett_Rensket)[colnames(Datasett_Rensket) == "knr, gnr, bnr, snr.y"] <- "Knr - Gnr - Bnr - Snr"
```

### Fjerner Kolonner vi ikke trenger

```{r}
Datasett_Rensket <- Datasett_Rensket %>% 
  select(-knr,
         -gnr,
         -bnr,
         -snr.x,
         -fnr.x,
         -snr.y,
         -fnr.y,
         -Utstedelsesdato,
         -TypeRegistrering,
         -...27)
```

```{r}
Datasett_Rensket <- Datasett_Rensket %>% 
  select(-KjopereOgSelgere,
         -PersonidEier,
         -PostnrEier,
         -PoststedEier,
         -Bruksenhettypekode,
         -Bruksenhettype,
         -Bolignr)
```

### Legger til DokumentAr fra Ambita inn i Datasett_Rensket

```{r}
Dato <- Ambita %>% 
  select(DokumentAr, Dokumentnr, DokumentDato, knr)
```

```{r}
Midlertidig <- inner_join(Datasett_Rensket, Dato, by = c("DokumentDato", "Dokumentnr"))
```

#### Lager et nytt datasett for sikkerhetsskyld for når vi går videre

```{r}
Analyse <- unique(Midlertidig)
```

## Filtrer ut kun boliger

```{r}
Analyse <- Analyse %>% 
  filter(Naeringsgruppe == "Bolig")
```

## Endrer Energikarakterer, og TRUE/FALSE verdier til tall

```{r}
Analyse <- Analyse %>%
  mutate(Energikar_num = recode(Energikarakter,
                                         'G' = 1,
                                         'F' = 2,
                                         'E' = 3,
                                         'D' = 4,
                                         'C' = 5,
                                         'B' = 6,
                                         'A' = 7)) %>% 
  select(-Energikarakter)
```

```{r}
Analyse <- Analyse %>%
  mutate(PrivatEid_num = recode(PrivatpersonSomEier,
                                         "True" = "1",
                                         "False" = "0")) %>% 
  select(-PrivatpersonSomEier)
```

```{r}
Analyse <- transform(Analyse, PrivatEid_num = as.numeric(PrivatEid_num))
```

```{r}
Analyse <- Analyse %>%
  mutate(HarHeis_num = recode(Harheis,
                                         "J" = "1",
                                         "N" = "0")) %>% 
  select(-Harheis)
```

```{r}
Analyse <- transform(Analyse, HarHeis_num = as.numeric(HarHeis_num))
```

```{r}
Analyse$GrenselinjeVannkant <- ifelse(Analyse$GrenselinjeVannkant, 1, 0)
Analyse$GrenselinjeVegkant <- ifelse(Analyse$GrenselinjeVegkant, 1, 0)
Analyse$RegistrertLandbruksregisteret <- ifelse(Analyse$RegistrertLandbruksregisteret, 1, 0)
Analyse$RegistrertGrunnforurensning <- ifelse(Analyse$RegistrertGrunnforurensning, 1, 0)
Analyse$RegistrertKulturminneEiendom <- ifelse(Analyse$RegistrertKulturminneEiendom, 1, 0)
Analyse$RegistrertGrunnerverv <- ifelse(Analyse$RegistrertGrunnerverv, 1, 0)
Analyse$RegistrertBoDriveplikt <- ifelse(Analyse$RegistrertBoDriveplikt, 1, 0)
Analyse$RegistrertKulturminneBygning <- ifelse(Analyse$RegistrertKulturminneBygning, 1, 0)
```

# Rydder

```{r}
rm(Data_Analyse_1,
   Data_Analyse_2,
   Datasett_Rensket,
   Dato,
   EnAmb,
   Midlertidig,
   Analyse)
```

# Leser inn finpusset Analyse Datasett fra Excell-fil

```{r}
Analyse <- suppressWarnings(read_excel("data/Analyse_Finpuss.xlsx"))
```

## Fikser latterlig mange NA-Verdier for Kjøkken, Vannforsyning & Avlop

```{r}
Analyse["Kjokken"][is.na(Analyse["Kjokken"])] <- "Ikke Oppgitt"
Analyse["VannKode"][is.na(Analyse["VannKode"])] <- 0
Analyse["Vannforsyning"][is.na(Analyse["Vannforsyning"])] <- "Ikke Oppgitt"
Analyse["AvlopsKode"][is.na(Analyse["AvlopsKode"])] <- 0
Analyse["Avlop"][is.na(Analyse["Avlop"])] <- "Ikke Oppgitt"
Analyse["MatValg"][is.na(Analyse["MatValg"])] <- "Ikke Oppgitt"
```

```{r}
Analyse <- transform(Analyse, BLEnergikWh = as.numeric(BLEnergikWh))
Analyse <- transform(Analyse, Bygningsnummer = as.numeric(Bygningsnummer))
```

```{r}
# Lager en kolonne som tar utgangspunkt i DokumentDato og henter ut måned/år i egen kolonne
Analyse <- Analyse %>%
  mutate(Year = year(DokumentDato),
         Month = month(DokumentDato),
         Quarter = (Month - 1) %/% 3 + 1,
         YearQuarter = paste(Year, "Q", Quarter, sep = "")) %>%
  relocate(YearQuarter, .before = DokumentDato)
```

```{r}
Analyse <- Analyse %>%
  mutate(O.Karak_num = recode(O.Karak,
                                         'Red' = 1,
                                         'Orange' = 2,
                                         'Yellow' = 3,
                                         'Lightgreen' = 4,
                                         'Green' = 5))
```

```{r}
Analyse <- Analyse %>%
  relocate(O.Karak_num, .before = BLEnergikWh)
```

```{r}
Analyse <- Analyse %>%
  mutate(MatValg_num = recode(MatValg,
                                         'Ikke Oppgitt' = 0,
                                         'Betong' = 1,
                                         'Mur/tegl' = 2,
                                         'Staal' = 3,
                                         'Tre' = 4))
```

```{r}
Analyse <- Analyse %>%
  relocate(MatValg_num, .before = Oms.Typ)
```

```{r}
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 1] <- 'G'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 2] <- 'F'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 3] <- 'E'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 4] <- 'D'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 5] <- 'C'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 6] <- 'B'
Analyse$EL.Kar.Original[Analyse$EL.Kar.Original == 7] <- 'A'
```

```{r}
Analyse$Alder <- Analyse$DokumentAr - Analyse$B.Ar
```

```{r}
Analyse <- Analyse %>%
  select(P, Alder, everything())
```

```{r}
Analyse <- Analyse %>% 
  select(-Year, -Month, -Quarter)
```

```{r}
Analyse$Alder[Analyse$Alder == -1] <- 0
```

# Flytter nye koordinater fra Ambita inn i vårt datasett

```{r}
Coords_Temp <- Ambita_Oppdatert
```

```{r}
colnames(Coords_Temp)[colnames(Coords_Temp) == "Bygningsnr"] <- "Bygningsnummer"
```

```{r}
Coords_Temp <- transform(Coords_Temp, Bygningsnummer = as.numeric(Bygningsnummer))
```

```{r}
Coords_Temp <- Coords_Temp %>% 
  select(Dokumentnr, Bygningsnummer, EiendomNordSor, EiendomOstVest)
```

```{r}
Analyse <- Analyse %>% 
  select(-EiendomNordSor, -EiendomOstVest)
```

```{r}
Temp <- inner_join(Analyse, Coords_Temp, by = c("Dokumentnr", "Bygningsnummer"))
```

```{r}
Analyse <- unique(Temp)
```

```{r}
Analyse <- Analyse %>%
  filter(Oms.Typ == "Fritt salg") 
```

```{r}
Analyse <- Analyse %>% 
  select(-RegBoDrivePlikt)
```


## Rydder i datasett

```{r}
rm(Ambita_Oppdatert,
   Coords_Temp,
   Temp)
```

# Lager kartfil ut av Analyse datasettet vårt

Latitude -\> Nord/Sør Longitude -\> Vest/Øst

```{r}
Analyse_sf <- Analyse
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  st_as_sf(coords = c("EiendomOstVest", "EiendomNordSor"),
           crs = st_crs(25833))
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  st_transform(5973)
```

```{r}
Bergen_sf <- Bergen
```

```{r}
Bergen_sf <- Bergen_sf %>% 
  st_as_sf(coords = c("long", "lat"),
           crs = st_crs(25833))
```

```{r}
Bergen_sf <- Bergen_sf %>% 
  st_transform(5973)
```

```{r}
Analyse_sf <- mutate(
  Analyse_sf,
  dist_cbd = st_distance(Analyse_sf, Bergen_sf),
  dist_cbd_km = units::set_units(dist_cbd, km)
  )
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  select(-dist_cbd)
```

```{r}
Analyse_sf$dist_cbd_km <- round(Analyse_sf$dist_cbd_km, 2)
```

```{r}
Analyse <- Analyse %>% 
  separate(Knr...Gnr...Bnr...Snr, c("Knr", "Gnr", "Bnr", "Snr"))
```

```{r}
Analyse <- Analyse %>%
  unite(col = "Matrikkel", c("Knr", "Gnr", "Bnr", "Snr"), sep = "/", remove = FALSE)
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  separate(Knr...Gnr...Bnr...Snr, c("Knr", "Gnr", "Bnr", "Snr"))
```

```{r}
Analyse_sf <- Analyse_sf %>%
  unite(col = "Matrikkel", c("Knr", "Gnr", "Bnr", "Snr"), sep = "/", remove = FALSE)
```

```{r}
Analyse_sf["EtasjeSeksjon"][is.na(Analyse_sf["EtasjeSeksjon"])] <- "Ikke Oppgitt"
```

```{r}
Analyse_sf <- Analyse_sf %>%
  mutate(Etasje_num = recode(EtasjeSeksjon,
                                         'Ikke Oppgitt' = 0,            
                                         'Underetasje' = 1,
                                         'Hovedetasje' = 2,
                                         'Loft' = 3,
                                         'Kjelleretasje' = 4)
                                                        ) %>% 
  relocate(Etasje_num, .before = EtasjeSeksjon)
```

# Lager analyse-datasett for hvert individuelle år i tillegg til det totale felles dokumentet

```{r}
Analyse_2019 <- Analyse[Analyse$DokumentAr == 2019,]
Analyse_2020 <- Analyse[Analyse$DokumentAr == 2020,]
Analyse_2021 <- Analyse[Analyse$DokumentAr == 2021,]
Analyse_2022 <- Analyse[Analyse$DokumentAr == 2022,]

Analyse_2019_sf <- Analyse[Analyse_sf$DokumentAr == 2019,]
Analyse_2020_sf <- Analyse[Analyse_sf$DokumentAr == 2020,]
Analyse_2021_sf <- Analyse[Analyse_sf$DokumentAr == 2021,]
Analyse_2022_sf <- Analyse[Analyse_sf$DokumentAr == 2022,]
```

```{r}
Analyse_2019_sf <- Analyse_2019_sf %>% 
  st_as_sf(coords = c("EiendomOstVest", "EiendomNordSor"),
           crs = st_crs(25833)) %>% 
  st_transform(5973)
```

```{r}
Analyse_2019_sf <- mutate(
  Analyse_2019_sf,
  dist_cbd = st_distance(Analyse_2019_sf, Bergen_sf),
  dist_cbd_km = units::set_units(dist_cbd, km)
  ) %>% 
  select(-dist_cbd)
```

```{r}
Analyse_2020_sf <- Analyse_2020_sf %>% 
  st_as_sf(coords = c("EiendomOstVest", "EiendomNordSor"),
           crs = st_crs(25833)) %>% 
  st_transform(5973)
```

```{r}
Analyse_2020_sf <- mutate(
  Analyse_2020_sf,
  dist_cbd = st_distance(Analyse_2020_sf, Bergen_sf),
  dist_cbd_km = units::set_units(dist_cbd, km)
  ) %>% 
  select(-dist_cbd)
```

```{r}
Analyse_2021_sf <- Analyse_2021_sf %>% 
  st_as_sf(coords = c("EiendomOstVest", "EiendomNordSor"),
           crs = st_crs(25833)) %>% 
  st_transform(5973)
```

```{r}
Analyse_2021_sf <- mutate(
  Analyse_2021_sf,
  dist_cbd = st_distance(Analyse_2021_sf, Bergen_sf),
  dist_cbd_km = units::set_units(dist_cbd, km)
  ) %>% 
  select(-dist_cbd)
```

```{r}
Analyse_2022_sf <- Analyse_2022_sf %>% 
  st_as_sf(coords = c("EiendomOstVest", "EiendomNordSor"),
           crs = st_crs(25833)) %>% 
  st_transform(5973)
```

```{r}
Analyse_2022_sf <- mutate(
  Analyse_2022_sf,
  dist_cbd = st_distance(Analyse_2022_sf, Bergen_sf),
  dist_cbd_km = units::set_units(dist_cbd, km)
  ) %>% 
  select(-dist_cbd)
```

```{r}
Analyse_2019_sf$dist_cbd_km <- round(Analyse_2019_sf$dist_cbd_km, 2)
Analyse_2020_sf$dist_cbd_km <- round(Analyse_2020_sf$dist_cbd_km, 2)
Analyse_2021_sf$dist_cbd_km <- round(Analyse_2021_sf$dist_cbd_km, 2)
Analyse_2022_sf$dist_cbd_km <- round(Analyse_2022_sf$dist_cbd_km, 2)
```

# Skriver ut datasettet vårt i CSV

```{r}
#write.csv(Analyse, "Analyse/Datasett_Analyse.csv")
#write.csv(Analyse_2019, "Analyse/Datasett_Analyse_2019.csv")
#write.csv(Analyse_2020, "Analyse/Datasett_Analyse_2020.csv")
#write.csv(Analyse_2021, "Analyse/Datasett_Analyse_2021.csv")
#write.csv(Analyse_2022, "Analyse/Datasett_Analyse_2022.csv")

#st_write(Analyse_sf, "Analyse/Datasett_Analyse_sf.gpkg")
#st_write(Analyse_2019_sf, "Analyse/Datasett_Analyse_sf_2019.gpkg")
#st_write(Analyse_2020_sf, "Analyse/Datasett_Analyse_sf_2020.gpkg")
#st_write(Analyse_2021_sf, "Analyse/Datasett_Analyse_sf_2021.gpkg")
#st_write(Analyse_2022_sf, "Analyse/Datasett_Analyse_sf_2022.gpkg")
```

## Skriver ut Shape fil (TEST)

```{r}
#write_sf(Analyse_sf, "Analyse/Analyse_Shape.shp")
```

```{r}
#siste
```

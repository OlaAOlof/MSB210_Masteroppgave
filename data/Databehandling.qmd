---
title: "Masteroppgave"
author: 
  "Kevin Ha"
  "Ola Andre Olofsson"
format: html
editor: visual
---

```{r setup}
library(readr)
library(readxl)
library(tidyverse)
library(dplyr)
```

# Databehandling - Rådata, ENOVA

## Lager datasett av Excel fra ENOVA

```{r}
Energi_2019 <- read_excel("Energikarakterer_2019.xls")
Energi_2020 <- read_excel("Energikarakterer_2020.xlsx")
Energi_2021 <- read_excel("Energikarakterer_2021.xlsx")
Energi_2022 <- read_excel("Energikarakterer_2022.xls")
```

## Fjerner Fnr(festenummer)

```{r}
Energi_2019 <- Energi_2019[,-5]
Energi_2020 <- Energi_2020[,-5]
Energi_2021 <- Energi_2021[,-5]
```

## Filtrerer ut kun Bergen med omegn

```{r}
Energi_2019_Vestland <- Energi_2019[Energi_2019$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
Energi_2020_Vestland <- Energi_2020[Energi_2020$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
Energi_2021_Vestland <- Energi_2021[Energi_2021$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
Energi_2022_Vestland <- Energi_2022[Energi_2022$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
```

### Rydder vekk fullstendige datasett, for kontroll og unngå å rote

```{r Rydder_Fullstendige_Datasett}
rm(Energi_2019)
rm(Energi_2020)
rm(Energi_2021)
rm(Energi_2022)
```

## Sammenslår datasett, fom. 2019 tom. 2022

```{r}
ENOVA_Vestland <- rbind(Energi_2019_Vestland, Energi_2020_Vestland, Energi_2021_Vestland, Energi_2022_Vestland) %>% 
  select(-EnergiVurderingDato, -BeregnetFossilandel, -Attestnummer, -HarEnergiVurdering)
```

## Fjerner rekker observasjoner med organisasjonsnummer

Vi velger å fjerne rekkene med organisasjonsnummer da dette er boliger eid og kjøpt av næringer. Vi er i denne oppgaven interesert i hvordan det i hovedsak påvirker private, og boliger med organisasjonsnummer blir dermed en verdi vi ikke har behov for.

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  filter(is.na(Organisasjonsnummer))
```

## Fjerner nå kolonnen for organisasjonsnummer

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  select(-Organisasjonsnummer, -Poststed)
```

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

# Databehandling - Rådata, Eigendomsverdi AS

```{r}
EV <- read_excel("EV_kommaseparert.xlsx") %>% 
  select(-CityDistrict)
```

# Koordinater, Boliger

## Leser inn filen for koordinater boliger

```{r}
KoordinaterVestland <- read_delim("KoordinaterVestland.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
```

## Filterer ut relevante kommuner

```{r}
KoordinaterVestland <- KoordinaterVestland[KoordinaterVestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
```

## Slår sammen på koordinater for boliger med ENOVA_Vestland

```{r}
KoordinaterVestland <- KoordinaterVestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

```{r}
merged_data <- inner_join(ENOVA_Vestland, KoordinaterVestland, by = "Matrikkelnummer")
```

```{r}
ENOVA_coords <- distinct(merged_data, GateAdresse, .keep_all = TRUE)
```

```{r}
ENOVA_coords <- ENOVA_coords %>%
  unite(col = "Matrikkel", c("Matrikkelnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Matrikkelnummer, -Snr, -Postnummer, -Utstedelsesdato, -TypeRegistrering, -Fnr)
```

### Rydder vekk fullstendige datasett, for kontroll og unngå å rote.

```{r}
rm(merged_data)
rm(KoordinaterVestland)
```

## Fjerner snr fra ENOVA_Vestland

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  select(-Snr)
```

# Koordinater, Bergen

```{r}
Bergen <- data.frame(
  id = 1,
  lat = 60.3925,
  long = 5.323333
)
```

### Ting å gjøre her:
Finne en ID vi kan bruke til å kombinere med ENOVA_Vestland/ENOVA_coords
  Kan henda me må laga ein eigen ID i Vestland_coords & Bergen datasettet, f.eks. ein nummerisk ID som me kan utnytta te å slå sammen desse to på?
Finne ut vilken format (CRS/EPSG) vi skal bruke på dette
Transponere datasettene

Mutate en felles koordinat (Lengde og bredde) for ENOVA_Vestland
Mutate en felles koordinat (Lengde og bredde) for Bergen
Bruke st_distance for å finne avstand i luftlinje mellom punktene for å finne distanste mellom sentrum og boliger
Sjekke og evt. konvertere til rett måleformat (km)


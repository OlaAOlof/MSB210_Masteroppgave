---
title: "Masteroppgave"
author: 
  "Kevin Ha"
  "Ola Andre Olofsson"
format: html
editor: visual
---

```{r setup}
library(readr)
library(readxl)
library(tidyverse)
library(dplyr)
```

# Databehandling - Rådata, ENOVA

## Lager datasett av Excel fra ENOVA

```{r}
# Kevin: Lagt inn suppressWarnings() for å slippe masse spam/warnings

Energi_2010_Vestland <- suppressWarnings(read_csv("Energikarakterer_2010.csv"))
Energi_2011_Vestland <- suppressWarnings(read_csv("Energikarakterer_2011.csv"))
Energi_2012_Vestland <- suppressWarnings(read_csv("Energikarakterer_2012.csv"))
Energi_2013_Vestland <- suppressWarnings(read_csv("Energikarakterer_2013.csv"))
Energi_2014_Vestland <- suppressWarnings(read_csv("Energikarakterer_2014.csv"))
Energi_2015_Vestland <- suppressWarnings(read_csv("Energikarakterer_2015.csv"))
Energi_2016_Vestland <- suppressWarnings(read_csv("Energikarakterer_2016.csv"))
Energi_2017_Vestland <- suppressWarnings(read_csv("Energikarakterer_2017.csv"))
Energi_2018_Vestland <- suppressWarnings(read_csv("Energikarakterer_2018.csv"))
Energi_2019_Vestland <- suppressWarnings(read_excel("Energikarakterer_2019.xlsx"))
Energi_2020_Vestland <- suppressWarnings(read_excel("Energikarakterer_2020.xlsx"))
Energi_2021_Vestland <- suppressWarnings(read_excel("Energikarakterer_2021.xlsx"))
Energi_2022_Vestland <- suppressWarnings(read_excel("Energikarakterer_2022.xlsx"))
```

```{r}
Energi_2010_Vestland <- Energi_2010_Vestland[Energi_2010_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2011_Vestland <- Energi_2011_Vestland[Energi_2011_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2012_Vestland <- Energi_2012_Vestland[Energi_2012_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2013_Vestland <- Energi_2013_Vestland[Energi_2013_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2014_Vestland <- Energi_2014_Vestland[Energi_2014_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2015_Vestland <- Energi_2015_Vestland[Energi_2015_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2016_Vestland <- Energi_2016_Vestland[Energi_2016_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2017_Vestland <- Energi_2017_Vestland[Energi_2017_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)

Energi_2018_Vestland <- Energi_2018_Vestland[Energi_2018_Vestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ] %>% 
  select(-Fnr)
```


## Sammenslår datasett, fom. 2019 tom. 2022

```{r}
ENOVA_Vestland <- rbind(
  Energi_2010_Vestland,
  Energi_2011_Vestland,
  Energi_2012_Vestland,
  Energi_2013_Vestland,
  Energi_2014_Vestland,
  Energi_2015_Vestland,
  Energi_2016_Vestland,
  Energi_2017_Vestland,
  Energi_2018_Vestland,
  Energi_2019_Vestland,
  Energi_2020_Vestland,
  Energi_2021_Vestland,
  Energi_2022_Vestland) %>% 
  select(
    -EnergiVurderingDato,
    -BeregnetFossilandel,
    -Attestnummer,
    -HarEnergiVurdering)
```

## Fjerner rekker observasjoner med organisasjonsnummer

Vi velger å fjerne rekkene med organisasjonsnummer da dette er boliger eid og kjøpt av næringer. Vi er i denne oppgaven interesert i hvordan det i hovedsak påvirker private, og boliger med organisasjonsnummer blir dermed en verdi vi ikke har behov for.

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  filter(is.na(Organisasjonsnummer))
```

## Fjerner nå kolonnen for organisasjonsnummer

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  select(-Organisasjonsnummer, -Poststed)
```

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
   select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

### Fjerner individuelle datasett fra ENOVA

```{r}
rm(Energi_2010_Vestland)
rm(Energi_2011_Vestland)
rm(Energi_2012_Vestland)
rm(Energi_2013_Vestland)
rm(Energi_2014_Vestland)
rm(Energi_2015_Vestland)
rm(Energi_2016_Vestland)
rm(Energi_2017_Vestland)
rm(Energi_2018_Vestland)
rm(Energi_2019_Vestland)
rm(Energi_2020_Vestland)
rm(Energi_2021_Vestland)
rm(Energi_2022_Vestland)
```


# Databehandling - Rådata, Eiendomsverdi AS

```{r}
EV <- read_excel("EV_kommaseparert.xlsx") %>% 
  select(-CityDistrict)
```

# Boligkoordinater

## Leser inn filen for boligkoordinater

```{r}
KoordinaterVestland <- read_delim("KoordinaterVestland.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
```

## Filterer ut relevante kommuner

```{r}
KoordinaterVestland <- KoordinaterVestland[KoordinaterVestland$Knr %in% c(4601, 4623, 4624, 4626, 4627, 4628, 4630, 4631, 4632), ]
```

## Slår sammen på koordinater for boliger med ENOVA_Vestland

```{r}
KoordinaterVestland <- KoordinaterVestland %>%
  unite(col = "Matrikkelnummer", c("Knr", "Gnr", "Bnr", "Andelsnummer"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Andelsnummer)
```

```{r}
merged_data <- inner_join(ENOVA_Vestland, KoordinaterVestland, by = "Matrikkelnummer")
```

```{r}
ENOVA_coords <- distinct(merged_data, GateAdresse, .keep_all = TRUE)
```

```{r}
ENOVA_coords <- ENOVA_coords %>%
  unite(col = "Matrikkel", c("Matrikkelnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Matrikkelnummer, 
         -Snr, 
         -Postnummer, 
         -Utstedelsesdato, 
         -TypeRegistrering, 
         -Fnr)
```

### Rydder vekk fullstendige datasett, for kontroll og unngå å rote.

```{r}
rm(merged_data)
rm(KoordinaterVestland)
```

## Fjerner snr fra ENOVA_Vestland

```{r}
# ENOVA_Vestland <- ENOVA_Vestland %>% 
  # select(-Snr)
```

# Koordinater, Bergen

```{r}
Bergen <- data.frame(
  id = 1,
  lat = 60.3925,
  long = 5.323333
)
```

### Ting å gjøre her:

Finne en ID vi kan bruke til å kombinere med ENOVA_Vestland/ENOVA_coords Kan henda me må laga ein eigen ID i Vestland_coords & Bergen datasettet, f.eks. ein nummerisk ID som me kan utnytta te å slå sammen desse to på? Finne ut vilken format (CRS/EPSG) vi skal bruke på dette Transponere datasettene

Mutate en felles koordinat (Lengde og bredde) for ENOVA_Vestland Mutate en felles koordinat (Lengde og bredde) for Bergen Bruke st_distance for å finne avstand i luftlinje mellom punktene for å finne distanste mellom sentrum og boliger Sjekke og evt. konvertere til rett måleformat (km)

# Databehandling - Ambita

Opprinnelig datasett inneholder 284 340 obs. of 121 variables, så før innlasting er det i Excel fjernet:

-   45 variabler

-   224 996 obs.

# Databehandling Ambita AS

```{r}
#Ambita <- read_excel("Ambita.xlsx")
#Ambita <- read_excel("Ambita_Fullstendig.xlsx")
```

```{r}
Ambita <- Ambita[Ambita$DokumentAr %in% c(2019, 2020, 2021, 2022), ]
```

## Tar vekk kolonner som ikke er relevante for oss

### Hovedvariabler som ikke er nødvendige

```{r}
Ambita <- Ambita %>% 
  select(-InternidDokument,
         -Embetenr,
         -DokumentAr,
         -Dokumentnr,
         -InternidRettsstiftelse,
         -Rettsstiftelsesnr,
         -Rettsstiftelsestypekode,
         -Rettsstiftelsestype,
         -AvgiftsGrunnlag,
         -AvgiftsAarsakkode,
         -AvgiftsAarsak,
         -Omsetningstypekode,
         -Anvendelseskode,
         -Boligtypekode,
         -AndelOmsatt,
         -FormalBoligseksjon,
         -OrganisasjonSomEier,
         -EtablertDato,
         -AdresseEier,
         -AndelTeller,
         -AndelNevner,
         -AndelStatus,
         -EiendomAdressegatenr,
         -Postnr,
         -Poststed,
         -BygningstypeKode,
         -Naeringsgruppekode,
         -Tattibrukdato,
         -Dokumenttypekode,
         -Dokumenttype,
         -InternidEiendom,
         -Festenr,
         -PromSKD,
         -KvmPrisSKD,
         -LigningsverdiSKD,
         -EiendomHoyde,
         -ObjektNivakode,
         -ObjektNiva,
         -AnonymIDEier,
         -PersonIDTypeKodeEier,
         -PersonIDTypeEier,
         -NavnEier,
         -BolignrEier,
         -DSFStatusKodeEier,
         -DSFStatusEier,
         -KjonnEier,
         -AlderEier,
         -InternidAdresse,
         -Bydel,
         -Bydelsnr,
         -Grunnkretsnr,
         -Grunnkrets,
         -AdresseHoyde,
         -InternidBygning,
         -InternIdBruksenhet,
         -Etasjekode,
         -Kjokkentypekode)
```

### Tar vekk variabler, men med mer forsiktighet

```{r}
Ambita <- Ambita %>% 
  select(-AdresseNordSor,
         -AdresseOstVest,
         -ID_MATRIKKELEN_EIENDOM,
         -ID_MATRIKKELEN_ADRESSE,
         -ID_MATRIKKELEN_BRUKSENHET,
         -ID_MATRIKKELEN_BYGNING)
```

## Endrer kolonne navn

```{r}
colnames(Ambita)[colnames(Ambita) == "Kommunenr"] <- "Knr"
colnames(Ambita)[colnames(Ambita) == "Gardsnr"] <- "Gnr"
colnames(Ambita)[colnames(Ambita) == "Bruksnr"] <- "Bnr"
colnames(Ambita)[colnames(Ambita) == "Seksjonsnr"] <- "Snr"
colnames(Ambita)[colnames(Ambita) == "Andelsnr"] <- "Andelsnummer"
colnames(Ambita)[colnames(Ambita) == "Bygningsnr"] <- "Bygningsnummer"
```


```{r}
# Her endrer vi alle Snr og Andelsnummer fra 0 til NA slik at det blir identisk som i ENOVA sitt datasett
Ambita$Snr[Ambita$Snr == 0] <- NA
Ambita$Andelsnummer[Ambita$Andelsnummer == 0] <- NA
```

```{r}
Ambita <- Ambita %>%
  unite(col = "Matrikkel", c("Knr", "Gnr", "Bnr", "Andelsnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Knr, -Gnr, -Bnr, -Snr, -Andelsnummer)
```

## Slår Sammen Ambita og ENOVA_coords

```{r}
ENOVA_Vestland <- ENOVA_Vestland %>% 
  unite(col = "Matrikkel", c("Matrikkelnummer", "Snr"), sep = "/", remove = FALSE) %>% 
  select(-Matrikkelnummer, -Snr)
```

```{r}
Sammen <- inner_join(Ambita, ENOVA_Vestland, by = "Bygningsnummer")
```

```{r}
#siste
```


---
title: "Masteroppgave"
author: 
  Kevin Ha
  Ola Andre Olofsson
format: html
editor: visual
editor_options: 
  chunk_output_type: inline
---

# Setup Chunk

```{r setup_base}
library(readr)
library(tidyverse)
library(dplyr)
library(lubridate)
#library(zoo)
library(sf)
library(sp)
library(spdep)
library(tmap)
library(spatialreg)
#library(magrittr)
#library(measurements)
library(tibble)
library(ggcorrplot)
library(huxtable)
library(plm)
library(car)
library(lmtest)
library(magick)
library(olsrr)
library(vip)
library(xgboost)
library(ranger)
library(rpart)
options(paged.print = FALSE)
```

# Leser inn datasettene for analyse

```{r Innlesing av data}
Analyse <- suppressWarnings(read_csv("Datasett_Analyse.csv")) %>% 
  select(-...1)
Analyse_sf <- suppressWarnings(st_read("Datasett_Analyse_sf.gpkg"))
Analyse_Shape <- suppressWarnings(read_sf("Analyse_Shape.shp"))
```

```{r Navngir shp}
shp <- "Analyse_Shape.shp"
class(st_geometry(st_read(shp, quiet = TRUE, type = 3)))
```

```{r Gjør variabler numerisk}
Analyse_sf <- transform(Analyse_sf, EiendomAreal = as.numeric(EiendomAreal))
Analyse_sf <- transform(Analyse_sf, BRA.Bolig = as.numeric(BRA.Bolig))
Analyse_sf <- transform(Analyse_sf, BRA.Tot = as.numeric(BRA.Tot))
Analyse_sf <- transform(Analyse_sf, BebygdAreal = as.numeric(BebygdAreal))
Analyse_sf <- transform(Analyse_sf, Bruksareal.Enhet = as.numeric(Bruksareal.Enhet))
```

Analyse_sf \<- suppressWarnings(st_read("Datasett_Analyse_sf.gpkg"))

```{r}
#Bolig_sf <- suppressWarnings(st_read("Bolig_Inkludert_Bergen.gpkg"))
#Bolig_Eksl_Bergen_sf <- suppressWarnings(st_read("Bolig_Ekskludert_Bergen.gpkg"))
Blokker_sf <- suppressWarnings(st_read("Blokker_Inkludert_Bergen.gpkg"))
Blokker_Eksl_Bergen_sf <- suppressWarnings(st_read("Blokker_Ekskludert_Bergen.gpkg"))
```

```{r}
#Bolig_sf <- transform(Bolig_sf, EiendomAreal = as.numeric(EiendomAreal))
#Bolig_sf <- transform(Bolig_sf, BebygdAreal = as.numeric(BebygdAreal))
#Bolig_Eksl_Bergen_sf <- transform(Bolig_Eksl_Bergen_sf, EiendomAreal = as.numeric(EiendomAreal))
#Bolig_Eksl_Bergen_sf <- transform(Bolig_Eksl_Bergen_sf, BebygdAreal = as.numeric(BebygdAreal))
Blokker_sf <- transform(Blokker_sf, EiendomAreal = as.numeric(EiendomAreal))
Blokker_sf <- transform(Blokker_sf, BebygdAreal = as.numeric(BebygdAreal))
Blokker_Eksl_Bergen_sf <- transform(Blokker_Eksl_Bergen_sf, EiendomAreal = as.numeric(EiendomAreal))
Blokker_Eksl_Bergen_sf <- transform(Blokker_Eksl_Bergen_sf, BebygdAreal = as.numeric(BebygdAreal))
```

```{r}
#Bolig <- read.csv("Bolig_Inkludert_Bergen.csv")
#Bolig_Eksl_Bergen <- read.csv("Bolig_Ekskludert_Bergen.csv")
#Blokker <- read.csv("Blokker_Inkludert_Bergen.csv")
#Blokker_Eksl_Bergen <- read.csv("Blokker_Ekskludert_Bergen.csv")
```

# Legg til KPI i datasettet

```{r}
Analyse_sf <- Analyse_sf %>%
  mutate(KPI = case_when(
    DokumentAr == 2019 ~ 1 + 0.022 + 0.053 + 0.059,
    DokumentAr == 2020 ~ 1 + 0.053 + 0.059,
    DokumentAr == 2021 ~ 1 + 0.059,
    TRUE ~ 1
  ))

# Beregn justerte priser
Analyse_sf <- Analyse_sf %>%
  mutate(justert_pm2 = pm2 * KPI) %>% 
  relocate(justert_pm2, .after = pm2)
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  select(KPI, everything())
```

```{r}
Analyse_sf <- Analyse_sf %>% 
  select(DokumentAr, everything())
```


# Fjerner SNR = 0

```{r SNR>0}
Analyse <- Analyse %>% 
  filter(Snr > 0)

Analyse_sf <- Analyse_sf %>% 
  filter(Snr > 0)

Blokker_sf <- Blokker_sf %>% 
  filter(Snr > 0)

#Bolig_sf <- Bolig_sf %>% 
#  filter(Snr > 0)

Blokker_Eksl_Bergen_sf <- Blokker_Eksl_Bergen_sf %>% 
  filter(Snr > 0)

#Bolig_Eksl_Bergen_sf <- Bolig_Eksl_Bergen_sf %>% 
#  filter(Snr > 0)
```

# Fjerner uteligger 1616

```{r}
Analyse_sf <- Analyse_sf[-1616,]
```

```{r}
Analyse <- Analyse[-1616,]
```

```{r}
Blokker_sf <- Blokker_sf[-1616,]
```

# Summary av datasettene

```{r Summary Analyse}
#summary(Analyse)
#summary(Analyse_sf)
```

# Lager en kolonne med kommune navn

```{r Mutater_Kommuner, eval=FALSE}
Analyse_sf <- Analyse_sf %>% 
  mutate(Kommune = recode(Knr,
                          4601 = "Bergen",
                          4624 = "Bjornafjorden",
                          4626 = "Oygarden",
                          4627 = "Askoy",
                          4628 = "Vaksdal",
                          4630 = "Osteroy",
                          4631 = "Alver",
                          4632 = "Austrheim"))
```

```{r}
Analyse_sf <- Analyse_sf %>%
  mutate(Kommune = case_when(
    Knr == 4601 ~ "Bergen",
    Knr == 4624 ~ "Bjornafjorden",
    Knr == 4626 ~ "Oygarden",
    Knr == 4627 ~ "Askoy",
    Knr == 4628 ~ "Vaksdal",
    Knr == 4630 ~ "Osteroy",
    Knr == 4631 ~ "Alver",
    Knr == 4632 ~ "Austrheim",
    TRUE ~ "Unknown"
  )) %>%
  relocate(Kommune, .before = Knr)
```

```{r}
Analyse <- Analyse %>%
  mutate(Kommune = case_when(
    Knr == 4601 ~ "Bergen",
    Knr == 4624 ~ "Bjornafjorden",
    Knr == 4626 ~ "Oygarden",
    Knr == 4627 ~ "Askoy",
    Knr == 4628 ~ "Vaksdal",
    Knr == 4630 ~ "Osteroy",
    Knr == 4631 ~ "Alver",
    Knr == 4632 ~ "Austrheim",
    TRUE ~ "Unknown"
  )) %>%
  relocate(Kommune, .before = Knr)
```

```{r}
Blokker_sf <- Blokker_sf %>%
  mutate(Kommune = case_when(
    Knr == 4601 ~ "Bergen",
    Knr == 4624 ~ "Bjornafjorden",
    Knr == 4626 ~ "Oygarden",
    Knr == 4627 ~ "Askoy",
    Knr == 4628 ~ "Vaksdal",
    Knr == 4630 ~ "Osteroy",
    Knr == 4631 ~ "Alver",
    Knr == 4632 ~ "Austrheim",
    TRUE ~ "Unknown"
  )) %>%
  relocate(Kommune, .before = Knr)
```

# Fikser på data før vi lager vektmatriser

```{r}
# Inkonsistens i data. Eksakt samme posisjon har forskjellig
# EiendomAdressegatenavn. EiendomAdressegatenavn er en variabel som 
# kan brukes analogt til TOWN i Boston eksempel, men da må SAMME punkt ha
# SAMME EiendomAdressegatenavn ellers får blocking rutinene problemer. Lager
# en ny variabel EAG_Blocking der dette fikses
# Lager også noen id-er for å identifisere de problematiske observasjonene
all_point_coords <- st_coordinates(Analyse_sf)
# Add id variabel made from coordinates before P in Analyse_sf
Analyse_sf <- rowid_to_column(Analyse_sf, "id")
Analyse_sf <- Analyse_sf  |> 
  mutate(
    id_adr = paste(
      EiendomAdressegatenavn,
      all_point_coords[,1], 
      all_point_coords[,2], 
      sep = "_"),
    id_coords = paste(
      all_point_coords[,1], 
      all_point_coords[,2], 
      sep = "_"),
    EAG_Blocking = EiendomAdressegatenavn,
    .before = "P"
  )

# Finner observasjonene som har SAMME koordinater, men forskjellig
# EiendomAdressegatenavn
Analyse_sf_ng <- st_drop_geometry(Analyse_sf)
duplicates_coord <- setdiff(
  Analyse_sf_ng[!duplicated(Analyse_sf_ng$id_adr),
             c("id", "id_coords")],
  Analyse_sf_ng[!duplicated(Analyse_sf_ng$id_coords),
             c("id", "id_coords")]
)

prob_obs <- Analyse_sf |> 
  filter(id_coords %in% duplicates_coord$id_coords) |> 
  arrange(id_coords, EiendomAdressegatenavn)

# I prob_obs ser vi hvilke obs. som skaper problemer
# Fikser problemet i EiendomAdressegatenavn_Blocking
Analyse_sf <- Analyse_sf |> 
  mutate(
    EAG_Blocking = case_when(
      # Endrer nattlandsrinden til nordre nattlandsfjellet
      id %in% c(82, 84, 86, 146) ~ "nordre nattlandsfjellet",
      # Endrer vallaheiane til vallalia
      id %in% c(227, 228, 233, 235) ~ "vallalia",
      # endrer koren wibergs plass til wesenbergsmauet
      id %in% c(56) ~ "wesenbergsmauet",
      # endrer jens rolfsens gate til nye sandviksveien
      id %in% c(1065) ~ "nye sandviksveien",
      # endrer michael krohns gate til damsgårdsveien
      id %in% c(435:441, 607:613) ~ "damsgårdsveien",
      # endrer johan berentsens vei til kringsjåveien
      id %in% c(865) ~ "kringsjåveien",
      # resten er uforandret
      TRUE ~ EAG_Blocking
    ),
    EAG_Blocking = paste(EAG_Blocking, id_coords, sep = "_")
  )
```

# Lager to unike punkter

## Punkt 1

```{r Punkt_1}
unike_punkt <- Analyse_sf |> 
  select(EAG_Blocking) |> 
  distinct()

rel_graph <- relativeneigh(
  coords = st_coordinates(unike_punkt),
  # scaling factor for memory allocation, 15 seems to work
  nnmult = 15
)
```

## Punkt 2

```{r Punkt_2}
# punkt 2
rel_nb <- graph2nb(
  gob = rel_graph,
  # områdenavnene, pull() for å gå fra tibbel med en var til vector
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
)
```

## Plot

```{r}
plot(rel_nb, st_coordinates(unike_punkt))
```

# Lager Vektmatrise, hva. "nb2blocknb"-funksjon

```{r}
block.nb <- nb2blocknb(
  rel_nb, 
  # Nå alle verdier av EAG_Blocking, dvs. flere duplikater som «blocks opp»
  ID = Analyse_sf$EAG_Blocking
  )
```

```{r}
block.nb
```

```{r}
plot(block.nb, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

```{r}
Analyse_w <- nb2listw(block.nb, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_w)
```

# Lager vektmatrise, hva. knearneigh

## Knearneigh; K=3

```{r K=3}
# 3 nearest neighbours
knn_3 <- knearneigh(st_coordinates(unike_punkt), k = 3)
nb_knn3 <- knn2nb(
  knn_3, 
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
  )
block.nb_knn3 <- nb2blocknb(
  nb_knn3,
  ID = Analyse_sf$EAG_Blocking
  )
Analyse_W3 <- nb2listw(block.nb_knn3, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_W3)
```

```{r K=3_Block.nb}
block.nb_knn3
```

```{r K=3, plot}
plot(block.nb_knn3, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

## Knearneigh; K=5

```{r K=5}
# 5 nearest neighbours
knn_5 <- knearneigh(st_coordinates(unike_punkt), k = 5)
nb_knn5 <- knn2nb(
  knn_5, 
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
  )
block.nb_knn5 <- nb2blocknb(
  nb_knn5,
  ID = Analyse_sf$EAG_Blocking
  )
Analyse_W5 <- nb2listw(block.nb_knn5, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_W5)
```

```{r K=5_Block.nb}
block.nb_knn5
```

```{r K=5, plot}
plot(block.nb_knn5, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

## Knearneigh; K=7

```{r K=5}
# 7 nearest neighbours
knn_7 <- knearneigh(st_coordinates(unike_punkt), k = 7)
nb_knn7 <- knn2nb(
  knn_7, 
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
  )
block.nb_knn7 <- nb2blocknb(
  nb_knn7,
  ID = Analyse_sf$EAG_Blocking
  )
Analyse_W7 <- nb2listw(block.nb_knn7, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_W7)
```

```{r K=5_Block.nb}
block.nb_knn7
```

```{r K=5, plot}
plot(block.nb_knn7, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

## Knearneigh; K=10

```{r K=10}
# 10 nearest neighbours
knn_10 <- knearneigh(st_coordinates(unike_punkt), k = 10)
nb_knn10 <- knn2nb(
  knn_10, 
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
  )
block.nb_knn10 <- nb2blocknb(
  nb_knn10,
  ID = Analyse_sf$EAG_Blocking
  )
Analyse_W10 <- nb2listw(block.nb_knn10, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_W10)
```

```{r K=10_Block.nb}
block.nb_knn10
```

```{r K=10, plot}
plot(block.nb_knn10, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

## Knearneigh; K=15

```{r K=15}
# 15 nearest neighbours
knn_15 <- knearneigh(st_coordinates(unike_punkt), k = 15)
nb_knn15 <- knn2nb(
  knn_15, 
  row.names = pull(st_drop_geometry(select(unike_punkt, EAG_Blocking))),
  sym = TRUE
  )
block.nb_knn15 <- nb2blocknb(
  nb_knn15,
  ID = Analyse_sf$EAG_Blocking
  )
Analyse_W15 <- nb2listw(block.nb_knn15, style = "W", zero.policy = TRUE)
# Har vi spatial autocorrelation i prisene?
moran.test(Analyse_sf$P, Analyse_W15)
```

```{r K=15_Block.nb}
block.nb_knn15
```

```{r K=15, plot}
plot(block.nb_knn15, coords = st_coordinates(Analyse_sf));points(st_coordinates(unike_punkt))
```

# Gammel kode, utgår. START

```{r KNN naboer, eval=FALSE}
#Kankje laga vektmatrisa på Analyse-datasettet. Må bli gjort på kart-datasettet "Analyse_sf"

#Analyse_mat_nb3 <- knearneigh(Analyse, k = 3)
#Analyse_nb3 <- knn2nb(Analyse_mat_nb3)
#Analyse_W3 <- nb2listw(Analyse_nb3, style = "W")
```

## Vektmatrise for Analyse_sf

### Tester Queen- og Rook

```{r Queen, eval=FALSE}
#queen.nb = poly2nb(Analyse_Shape)
```

```{r Queen list, eval=FALSE}
#queen.listw = nb2listw(queen.nb)
```

```{r Rook, eval=FALSE}
#rook.nb = poly2nb(Analyse_Shape, queen = FALSE)
```

```{r Rook list, eval=FALSE}
#rook.listw = nb2listw(rook.nb)
```

```{r List W, eval=FALSE}
#listw1 = queen.listw
```

### Tester K-nærmeste-naboer-metoden

Her bruker vi den k-nærmeste naboer-metoden, som baserer seg på avstanden mellom punktene. Queen- og Rook-kriteriene brukes for å definere naboer i polygondata. Queen-kriteriet sier at polygoner er naboer hvis de deler minst ett punkt (hjørne eller kant), mens Rook-kriteriet sier at polygoner er naboer hvis de deler minst en kant.

K-nærmeste naboer-metoden som brukes fremvoer fungerer for punktdata og definerer naboer basert på avstanden mellom punktene. For hver observasjon finner den k nærmeste naboene, der k er en forhåndsbestemt verdi (k = 3, k = 5 og k = 10).

#### Vektmatrise, K = 3

Oppretter romlige vektmatriser for k-nærmeste naboer med k = 3

nb2blocknb

```{r KNN 3, eval=FALSE}
Analyse_sf_mat_nb3 <- knearneigh(Analyse_sf, k = 3)
Analyse_sf_nb3 <- knn2nb(Analyse_sf_mat_nb3)
Analyse_sf_W3 <- nb2listw(Analyse_sf_nb3, style = "W")
```

# Forsøk på ny matrise etter ny funksjon fra Arnstein

```{r KNN 3, eval=FALSE}
#Analyse_sf_mat_nb3 <- knearneigh(Analyse_sf, k = 3)
#Analyse_sf_nb3 <- nb2blocknb(Analyse_sf_mat_nb3)
#Analyse_sf_W3 <- nb2listw(Analyse_sf_nb3, style = "W")
```

```{r KNN 3}
# Hent ut x- og y-koordinater fra geometrikolonnen
#coords <- suppressWarnings(st_coordinates(st_centroid(Analyse_sf)))

# Opprett relativeneigh-objektet med en økt nnmult-verdi
#Analyse_sf_mat_nb3 <- knearneigh(Analyse_sf, k = 3)

# Konverterer knearneigh til en naboliste
#Analyse_sf_nb3 <- knn2nb(Analyse_sf_mat_nb3)

# Bruker funksjonen nb2blocknb
#Analyse_sf_block_nb3 <- nb2blocknb(Analyse_sf_nb3, ID = as.character(Analyse_sf$Dokumentnr))

# Opprett den romlige vektmatrisen for blokknaboene
#Analyse_sf_W3 <- nb2listw(Analyse_sf_block_nb3, style = "W")
```

#### Vektmatrise, K = 5

Oppretter romlige vektmatriser for k-nærmeste naboer med k = 5

```{r KNN 5, eval=FALSE}}
Analyse_sf_mat_nb5 <- knearneigh(Analyse_sf, k = 5)
Analyse_sf_nb5 <- knn2nb(Analyse_sf_mat_nb5)
Analyse_sf_W5 <- nb2listw(Analyse_sf_nb5, style = "W")
```

#### Vektmatrise, K = 10

Oppretter romlige vektmatriser for k-nærmeste naboer med k = 10

```{r KNN 10, eval=FALSE}}
Analyse_sf_mat_nb10 <- knearneigh(Analyse_sf, k = 10)
Analyse_sf_nb10 <- knn2nb(Analyse_sf_mat_nb10)
Analyse_sf_W10 <- nb2listw(Analyse_sf_nb10, style = "W")
```

# Kontroll av nabolagsmatrise - Kevin

```{r Nabomatrise, eval=FALSE}}
# Funksjonen returnerer en matrise med indeksene til punktene som tilhører settet av de k nærmeste naboene til hverandre.

bergen <- st_read(("Analyse_Shape.shp"), quiet=TRUE)
coords <- st_centroid(st_geometry(bergen), of_largest_polygon=TRUE)
col.knn <- knearneigh(coords, k=3)
plot(st_geometry(bergen), border="grey")
plot(knn2nb(col.knn), coords, add=TRUE)
title(main="K naermeste naboer, k = 3")
```

Funksjonen returnerer en matrise med indeksene til punktene som tilhører settet av de k nærmeste naboene til hverandre.

```{r Nabomatrise med farger og punkt, eval=FALSE}}
# Nå plotter vi punktene og naboene for et utvalg av punkter for å se om det ser ut som om de har riktig antall naboer (k = 10).
plot(st_geometry(Analyse_sf), pch = 19, cex = 0.5, col = "blue")

# Velg et punkt for å se naboene
point_index <- 1

# Plot de valgte pointsene og naboene
plot(Analyse_sf[point_index, ], col = "red", pch = 19, cex = 1.2, add = TRUE)
plot(Analyse_sf[names(Analyse_sf_nb10[[point_index]]), ], col = "green", pch = 19, cex = 10, add = TRUE)

# Legger til beskrivelse
legend("bottomright", legend = c("Points", "Selected point", "Naboer (k = 10)"),
       col = c("blue", "red", "green"), pch = 19, cex = 0.8)
```

## Norgeskart med våre salg - Kevin

```{r Norgeskart, eval=FALSE}
Analyse_Shape <- st_read("Analyse_Shape.shp")
norge <- st_read("norge.shp")

Transformerer kartene til samme CRS
norge <- st_transform(norge, crs = st_crs(Analyse_Shape))

Plotter  MultiPolygon-data
ggplot() + 
  geom_sf(data = norge) +
  theme_bw()

Legger til point-data på toppen av MultiPolygon data
ggplot() + 
  geom_sf(data = norge) +
  geom_sf(data = Analyse_Shape, color = "red") +
  theme_bw()
```

# Morans I - Kevin

```{r Kevins Moran, eval=FALSE}
# Definer en variabel for romlig analyse
Pris <- Analyse_sf$P

# Beregn Global Moran's I for k = 3, k = 5 og k = 10
moran_3 <- moran.test(Pris, Analyse_sf_W3)
moran_5 <- moran.test(Pris, Analyse_sf_W5)
moran_10 <- moran.test(Pris, Analyse_sf_W10)

# Vis resultater
cat("Global Moran's I (k = 3):", moran_3$estimate, "\n")
cat("Global Moran's I (k = 5):", moran_5$estimate, "\n")
cat("Global Moran's I (k = 10):", moran_10$estimate, "\n")
```

Disse resultatene viser Global Moran's I-verdier for k = 3, k = 5 og k = 10. Global Moran's I er et mål på romlig autokorrelasjon som gir en indikasjon på hvordan en variabel (i dette tilfellet "Pris") er korrelert med seg selv i rommet. I dette tilfellet er variabelen "Pris" korrelert med sine nærmeste naboer.

Resultatene viser følgende: Global Moran's I (k = 3): 0.3930968 Global Moran's I (k = 5): 0.3361125 Global Moran's I (k = 10): 0.2473997 Global Moran's I-verdier varierer mellom -1 og 1:

Verdier nær 1 indikerer positiv romlig autokorrelasjon, der lignende verdier er gruppert sammen i rommet. Verdier nær -1 indikerer negativ romlig autokorrelasjon, der ulike verdier er gruppert sammen i rommet. Verdier nær 0 indikerer ingen romlig autokorrelasjon, der verdier er jevnt fordelt i rommet. I dette tilfellet er alle Global Moran's I-verdier positive, noe som tyder på positiv romlig autokorrelasjon. Det betyr at høyere priser har en tendens til å være nærmere hverandre, og lavere priser har en tendens til å være nærmere hverandre i rommet.

Det er viktig å merke seg at Moran's I-verdien avtar når antall naboer (k) øker. Dette kan skyldes at når flere naboer inkluderes i analysen, blir det mindre sannsynlig at hver enhet har naboer med lignende verdier.

Tallene etter Moran's I-verdiene i resultatene (-0.0003374958 og 0.0001646533 for k = 3, osv.) er konstantleddet og koeffisienten for x i Moran's I-beregningen. Disse tallene brukes for å beregne Moran's I-verdien og er ikke av stor interesse for tolkningen av resultatene.

## Gammel kode, utgår. SLUTT

-   

# Korrelasjonsmatriser

## Sjekket for korrelasjon og multikollinearitet

Sjekk korrelasjon mellom - EiendomAreal - BRA.Bolig - BRA.Annet - BRA.Tot - BebygdAreal - Bruksareal.Enhet

```{r Korrelasjonsmatrise Eiendom, eval=FALSE}
cor_matrix <- cor(Analyse[c("EiendomAreal", "BRA.Bolig", "BRA.Annet", "BRA.Tot", "BebygdAreal", "Bruksareal.Enhet")])
print(cor_matrix)
```

```{r Visualisering av korrelasjonsmatrise, eval=FALSE}
ggcorrplot(cor_matrix)
```

## Sjekker multikollinearitet

```{r lager lineær modell1}
linear_model_1 <- lm(P ~ Alder + EL.Kar + O.Karak_num + BLEnergikWh + MatValg_num + AntEiendom + EiendomAreal + BRA.Bolig + Bruksareal.Enhet + Etasje + VannkantGL + VegkantGL + BebygdAreal + RegLBE + RegGrunnforur + RegKulturEiendom + RegGrunnerverv + TotBoliger + RegKulturByg + AntallRom + AntallBad + AntallWC + PrivatEid + HarHeis + VannKode + AvlopsKode + BolType + Kjokken + YearQuarter, data = Analyse)
```

```{r Sjekker multikollinearitet i lm1, eval=FALSE}
vif_values_1 <- vif(linear_model_1)
print(vif_values_1)
```

Vi ønsker GVIF verdier så nærme 1 som mulig. Verdier mindre enn 5 er akseptable, mens verdier over 5 må kastes. Med dette i bakhånd velger vi dermed å forkaste TotBoliger variablen. Dette kommer også av at vi er interessert i kjøp av boliger, så om det er 1 eller 10 boliger som blir solgt har ikkje så mykje å si for personen som kjøper boligen.

**GVIF-Verdier på 1.02 til 1.6. Dette er variabler vi kan bruke**

```{r lager lineær modell2}
linear_model_2 <- lm(P ~ EiendomAreal + dist_cbd_km, data = Analyse_sf)
```

```{r Sjekker multikollinearitet i lm2, eval=FALSE}
vif_values_2 <- vif(linear_model_2)
print(vif_values_2)
```

```{r lager lineær modell3}
linear_model_3 <- lm(P ~ BRA.Bolig + dist_cbd_km, data = Analyse_sf)
```

```{r Sjekker multikollinearitet i lm3, eval=FALSE}
vif_values_3 <- vif(linear_model_3)
print(vif_values_3)
```

```{r lager lineær modell4}
linear_model_4 <- lm(P ~ Bruksareal.Enhet + dist_cbd_km, data = Analyse_sf)
```

```{r Sjekker multikollinearitet i lm4, eval=FALSE}
vif_values_4 <- vif(linear_model_4)
print(vif_values_4)
```

En GVIF-verdi på mindre enn 5 regnes som akseptabelt for å unngå signifikant multikollinearitet. Her har BRA.Bolig og BebygdAreal en GVIF-verdi på henholdsvis 2.03 og 1.87, som indikerer at det ikke er noen signifikant multikollinearitet mellom dem. Bruksareal.Enhet har også en lav GVIF-verdi på 1.75, selv om antallet koeffisienter i modellen er høyt (220), som kan tyde på at det ikke er noen signifikant multikollinearitet mellom denne variabelen og de andre variablene i modellen. Dermed er det sannsynlig at disse variablene kan brukes sammen i en regresjonsmodell uten å påvirke modellens prediktive kraft eller nøyaktighet negativt på grunn av multikollinearitet.

```{r Fullstendig korrelasjonsmatrise, eval=FALSE}
cor_matrix_1 <- cor(Analyse[c("P", "Alder", "EL.Kar", "O.Karak_num", "BLEnergikWh", "MatValg_num", "AntEiendom", "EiendomAreal", "BRA.Bolig", "Bruksareal.Enhet", "Etasje", "VannkantGL", "VegkantGL", "BebygdAreal", "RegLBE", "RegGrunnforur", "RegKulturEiendom", "RegGrunnerverv", "TotBoliger", "RegKulturByg", "AntallRom", "AntallBad", "AntallWC", "PrivatEid", "HarHeis", "VannKode", "AvlopsKode")])
ggcorrplot(cor_matrix_1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8.5)) +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 8.5))
```

```{r Visualisering av fullstendig korrelasjonsmatrise, eval=FALSE}
zoomi <- ggcorrplot(cor_matrix_1) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8.5)) +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, size = 8.5))

 Save the ggcorrplot as a high-resolution image
ggsave("zoomi.jpeg", zoomi, dpi = 500)
```

```{r Print av fullstendig korrelasjonsmatrise, eval=FALSE}
cor_matrix_1 <- round(cor_matrix_1, 2)
print(cor_matrix_1)
```

```{r Korrelasjonsmatrise rom, eval=FALSE}
cor_matrix_2 <- cor(Analyse[c("P", "AntallRom", "AntallBad", "AntallWC")])
ggcorrplot(cor_matrix_2)
```

```{r Korrelasjonsmatrise diverse, eval=FALSE}
cor_matrix_3 <- cor(Analyse[c("P", "Alder", "BLEnergikWh", "EL.Kar", "O.Karak_num", "MatValg_num")])
ggcorrplot(cor_matrix_3)
```

```{r Korrelasjonsmatrise areal og rom, eval=FALSE}
cor_matrix_4 <- cor(Analyse[c("P", "BRA.Bolig", "Bruksareal.Enhet", "AntallRom", "AntallBad", "AntallWC")])
ggcorrplot(cor_matrix_4)
```

```{r Korrelasjons mellom pris og distanse, eval=FALSE}
correlation <- cor(Analyse_sf$dist_cbd_km, Analyse$P, method = "pearson")
print(correlation)
```

```{r Korrelasjon i .sf-fil, eval=FALSE}
cor_matrix <- cor(Analyse_sf[c("P", "EL.Kar", "Alder", "Etasje", "AntallRom")])
ggcorrplot(cor_matrix, type = "lower", hc.order = TRUE, lab = TRUE)
```

# Lager modeller

# Fellesgjeldproblematikken

```{r}
Selveier <- Analyse_sf %>% 
  filter(Snr > 0)
```

```{r}
FG <- Analyse_sf %>% 
  filter(Snr == 0)
```

# Fjerner Snr = 0 Observasjoner

**Ut ifra tilbakemeldinger fra veileder, så fjerner vi observasjoner som har Snr = 0, da disse er med fellesgjeld, og ikke hadde noe signifikant utslag i våres analyse. Vi må gjøre dette på på grunnleggende datasettene, samt på alle datasett som vi bruker i analysen**

```{r SNR_0, eval=FALSE}
Analyse <- Analyse %>% 
  filter(Snr > 0)

Analyse_sf <- Analyse_sf %>% 
  filter(Snr > 0)

Blokker_sf <- Blokker_sf %>% 
  filter(Snr > 0)

Bolig_sf <- Bolig_sf %>% 
  filter(Snr > 0)

Blokker_Eksl_Bergen_sf <- Blokker_Eksl_Bergen_sf %>% 
  filter(Snr > 0)

Bolig_Eksl_Bergen_sf <- Bolig_Eksl_Bergen_sf %>% 
  filter(Snr > 0)
```

# Regresjonsmodeller

## Blokker

### Modell 1

```{r Modell Blokk_1}
options(scipen = 999)

modBlokk1 <- "I(log(pm2)) ~ EL.Kar.Original"
OLSBlokk1 <- lm(modBlokk1, data = Blokker_sf)
summary(OLSBlokk1)
AIC(OLSBlokk1)
BIC(OLSBlokk1)
```

### Modell 2

```{r  Modell Blokk_2}
options(scipen = 999)

modBlokk2 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1))"
OLSBlokk2 <- lm(modBlokk2, data = Blokker_sf)
summary(OLSBlokk2)
AIC(OLSBlokk2)
BIC(OLSBlokk2)
```

### Modell 3

```{r Modell Blokk_3}
options(scipen = 999)

modBlokk3 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak"
OLSBlokk3 <- lm(modBlokk3, data = Blokker_sf)
summary(OLSBlokk3)
AIC(OLSBlokk3)
BIC(OLSBlokk3)
```

### Modell 4

**OLA: Eg TRUR da e log(BLEnergikWh), uten "+1" på slutten. Har sjekka og studert fjorårets master, korleis dei gjere da, og ser ut te at dei gjere da på lik metode.**

```{r Modell Blokk_4}
options(scipen = 999)

modBlokk4 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh)"
OLSBlokk4 <- lm(modBlokk4, data = Blokker_sf)
summary(OLSBlokk4)
AIC(OLSBlokk4)
BIC(OLSBlokk4)
```

### Modell 5

```{r Modell Blokk_5}
options(scipen = 999)

modBlokk5 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg"
OLSBlokk5 <- lm(modBlokk5, data = Blokker_sf)
summary(OLSBlokk5)
AIC(OLSBlokk5)
BIC(OLSBlokk5)
```

### Modell 6

```{r Modell Blokk_6}
options(scipen = 999)

modBlokk6 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1))"
OLSBlokk6 <- lm(modBlokk6, data = Blokker_sf)
summary(OLSBlokk6)
AIC(OLSBlokk6)
BIC(OLSBlokk6)
```

### Modell 7 (UTGÅR)

**OLA: Denna utgår. Sio me no har splitta da i 2, eit for leilighetar og eit for boligar, så e da ikkje relevant å bruka BRA.Bolig variabelen her.**

```{r, eval=FALSE}
#options(scipen = 999)

#mod7 <- "pm2 ~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + EiendomAreal + BRA.Bolig"
#OLS7 <- lm(mod7, data = Blokker_sf)
#summary(OLS7)
#AIC(OLS7)
#BIC(OLS7)
```

### Modell 7 (FORTSETTELSE)

```{r Modell Blokk_7}
options(scipen = 999)

modBlokk7 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) +
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet))"
OLSBlokk7 <- lm(modBlokk7, data = Blokker_sf)
summary(OLSBlokk7)
AIC(OLSBlokk7)
BIC(OLSBlokk7)
```

### Modell 8

```{r Modell Blokk_8}
options(scipen = 999)

modBlokk8 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon"
OLSBlokk8 <- lm(modBlokk8, data = Blokker_sf)
summary(OLSBlokk8)
AIC(OLSBlokk8)
BIC(OLSBlokk8)
```

### Modell 9

```{r Modell Blokk_9}
options(scipen = 999)

modBlokk9 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL"
OLSBlokk9 <- lm(modBlokk9, data = Blokker_sf)
summary(OLSBlokk9)
AIC(OLSBlokk9)
BIC(OLSBlokk9)
```

### Modell 10

```{r Modell Blokk_10}
options(scipen = 999)

modBlokk10 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL"
OLSBlokk10 <- lm(modBlokk10, data = Blokker_sf)
summary(OLSBlokk10)
AIC(OLSBlokk10)
BIC(OLSBlokk10)
```

### Modell 11

```{r Modell Blokk_11}
options(scipen = 999)

modBlokk11 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1))"
OLSBlokk11 <- lm(modBlokk11, data = Blokker_sf)
summary(OLSBlokk11)
AIC(OLSBlokk11)
BIC(OLSBlokk11)
```

### Modell 12

```{r Modell Blokk_12}
options(scipen = 999)

modBlokk12 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE"
OLSBlokk12 <- lm(modBlokk12, data = Blokker_sf)
summary(OLSBlokk12)
AIC(OLSBlokk12)
BIC(OLSBlokk12)
```

### Modell 13

```{r Modell Blokk_13}
options(scipen = 999)

modBlokk13 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur"
OLSBlokk13 <- lm(modBlokk13, data = Blokker_sf)
summary(OLSBlokk13)
AIC(OLSBlokk13)
BIC(OLSBlokk13)
```

### Modell 14

```{r Modell Blokk_14}
options(scipen = 999)

modBlokk14 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom"
OLSBlokk14 <- lm(modBlokk14, data = Blokker_sf)
summary(OLSBlokk14)
AIC(OLSBlokk14)
BIC(OLSBlokk14)
```

### Modell 15

```{r Modell Blokk_15}
options(scipen = 999)

modBlokk15 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv"
OLSBlokk15 <- lm(modBlokk15, data = Blokker_sf)
summary(OLSBlokk15)
AIC(OLSBlokk15)
BIC(OLSBlokk15)
```

### Modell 16

```{r Modell Blokk_16}
options(scipen = 999)

modBlokk16 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg"
OLSBlokk16 <- lm(modBlokk16, data = Blokker_sf)
summary(OLSBlokk16)
AIC(OLSBlokk16)
BIC(OLSBlokk16)
```

### Modell 17

```{r Modell Blokk_17}
options(scipen = 999)
modBlokk17 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom))"
OLSBlokk17 <- lm(modBlokk17, data = Blokker_sf)
summary(OLSBlokk17)
AIC(OLSBlokk17)
BIC(OLSBlokk17)
```

### Modell 18

```{r Modell Blokk_18}
options(scipen = 999)
modBlokk18 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad))"
OLSBlokk18 <- lm(modBlokk18, data = Blokker_sf)
summary(OLSBlokk18)
AIC(OLSBlokk18)
BIC(OLSBlokk18)
```

### Modell 19

```{r Modell Blokk_19}
options(scipen = 999)
modBlokk19 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC))"
OLSBlokk19 <- lm(modBlokk19, data = Blokker_sf)
summary(OLSBlokk19)
AIC(OLSBlokk19)
BIC(OLSBlokk19)
```

### Modell 20

```{r Modell Blokk_20}
options(scipen = 999)
modBlokk20 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid"
OLSBlokk20 <- lm(modBlokk20, data = Blokker_sf)
summary(OLSBlokk20)
AIC(OLSBlokk20)
BIC(OLSBlokk20)
```

### Modell 21

```{r Modell Blokk_21}
options(scipen = 999)
modBlokk21 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis"
OLSBlokk21 <- lm(modBlokk21, data = Blokker_sf)
summary(OLSBlokk21)
AIC(OLSBlokk21)
BIC(OLSBlokk21)
```

### Modell 22

```{r Modell Blokk_22}
options(scipen = 999)
modBlokk22 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode"
OLSBlokk22 <- lm(modBlokk22, data = Blokker_sf)
summary(OLSBlokk22)
AIC(OLSBlokk22)
BIC(OLSBlokk22)
```

### Modell 23

```{r Modell Blokk_23}
options(scipen = 999)
modBlokk23 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode"
OLSBlokk23 <- lm(modBlokk23, data = Blokker_sf)
summary(OLSBlokk23)
AIC(OLSBlokk23)
BIC(OLSBlokk23)
```

### Modell 24

```{r Modell Blokk_24}
options(scipen = 999)
modBlokk24 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode + 
  BolType"
OLSBlokk24 <- lm(modBlokk24, data = Blokker_sf)
summary(OLSBlokk24)
AIC(OLSBlokk24)
BIC(OLSBlokk24)
```

### Modell 25

```{r Modell Blokk_25}
options(scipen = 999)
modBlokk25 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode + 
  BolType + 
  Kjokken"
OLSBlokk25 <- lm(modBlokk25, data = Blokker_sf)
summary(OLSBlokk25)
AIC(OLSBlokk25)
BIC(OLSBlokk25)
```

### Modell 26

**OLA: Litt usikker på om YearQuarter variabelen e rekna som ein "dummy"-variabel eller ikkje. Så har foreløpig lagt den inn i I(log()) funksjon. Detta må avkreftast!**

```{r Modell Blokk_26}
options(scipen = 999)
modBlokk26 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode + 
  BolType + 
  Kjokken + 
  YearQuarter"
OLSBlokk26 <- lm(modBlokk26, data = Blokker_sf)
summary(OLSBlokk26)
AIC(OLSBlokk26)
BIC(OLSBlokk26)
```

### Modell 27

```{r Modell Blokk_27}
options(scipen = 999)
modBlokk27 <- "I(log(pm2)) ~ EL.Kar.Original + 
  I(log(Alder+1)) + 
  O.Karak + 
  log(BLEnergikWh) + 
  MatValg + 
  I(log(EiendomAreal+1)) + 
  I(log(Bruksareal.Enhet)) + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  I(log(BebygdAreal+1)) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  I(log(AntallRom)) + 
  I(log(AntallBad)) + 
  I(log(AntallWC)) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode + 
  BolType + 
  Kjokken + 
  YearQuarter + 
  I(log(dist_cbd_km))"
OLSBlokk27 <- lm(modBlokk27, data = Blokker_sf)
summary(OLSBlokk27)
AIC(OLSBlokk27)
BIC(OLSBlokk27)
```

### Model for kun energirelaterte karakteristika

```{r Modell Blokk_Energi}
options(scipen = 999)

modBlokkEnergi <- "I(log(pm2)) ~ EL.Kar.Original + O.Karak + log(BLEnergikWh) + MatValg"
OLSBlokkEnergi <- lm(modBlokkEnergi, data = Blokker_sf)
summary(OLSBlokkEnergi)
AIC(OLSBlokkEnergi)
BIC(OLSBlokkEnergi)
```

# VarImplot

*Link til side med mal: https://koalaverse.github.io/vip/articles/vip.html*

```{r rfo_pris}
rfo_pris <- ranger(pm2 ~ 
  EL.Kar.Original + 
  Alder + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
#  EiendomAreal + 
  Bruksareal.Enhet + 
  EtasjeSeksjon + 
  VannkantGL + 
#  VegkantGL + 
#  BebygdAreal + 
#  RegLBE + 
#  RegGrunnforur + 
  RegKulturEiendom + 
#  RegGrunnerverv + 
  RegKulturByg + 
  AntallRom + 
  AntallBad + 
  AntallWC + 
  PrivatEid + 
  HarHeis + 
#  VannKode + 
#  AvlopsKode + 
  BolType + 
#  Kjokken + 
  YearQuarter +
  Kommune, 
    data = Analyse,
      importance = "impurity")
```

```{r rfo_energi}
rfo_energi <- ranger(EL.Kar ~ 
  pm2 + 
  Alder + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
#  EiendomAreal + 
  Bruksareal.Enhet + 
  EtasjeSeksjon + 
  VannkantGL + 
#  VegkantGL + 
#  BebygdAreal + 
#  RegLBE + 
#  RegGrunnforur + 
  RegKulturEiendom + 
#  RegGrunnerverv + 
  RegKulturByg + 
  AntallRom + 
  AntallBad + 
  AntallWC + 
  PrivatEid + 
  HarHeis + 
#  VannKode + 
#  AvlopsKode + 
  BolType + 
#  Kjokken + 
  YearQuarter +
  Kommune, 
    data = Analyse,
      importance = "impurity")
```

```{r}
vi_rfo2 <- importance(rfo_pris, type = 1)
var_imp_df_pris <- data.frame(variable = names(vi_rfo2),
                         importance = vi_rfo2,
                         stringsAsFactors = FALSE)

var_imp_df_pris <- var_imp_df_pris[order(-var_imp_df_pris$importance),]
```

```{r}
vi_rfo3 <- importance(rfo_energi, type = 1)
var_imp_df_energi <- data.frame(variable = names(vi_rfo3),
                         importance = vi_rfo3,
                         stringsAsFactors = FALSE)

var_imp_df_energi <- var_imp_df_energi[order(-var_imp_df_energi$importance),]
```

```{r}
ggplot(var_imp_df_pris, aes(x = reorder(variable, importance), y = importance, fill = importance)) +
  geom_col(show.legend = FALSE) +
  scale_fill_gradient(low = "#64D0DF", high = "#004357") +
  labs(title = "Variable Importance - Pris", x = "Predictor Variable", y = "Importance") +
  theme_minimal() +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.border = element_blank(),
        plot.margin = unit(c(0.01,0.01,0.01,0.01), "lines")) +
  coord_flip()
```

```{r}
ggplot(var_imp_df_energi, aes(x = reorder(variable, importance), y = importance, fill = importance)) +
  geom_col(show.legend = FALSE) +
  scale_fill_gradient(low = "#64D0DF", high = "#004357") +
  labs(title = "Variable Importance - Energikarakter", x = "Predictor Variable", y = "Importance") +
  theme_minimal() +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.border = element_blank(),
        plot.margin = unit(c(0.01,0.01,0.01,0.01), "lines")) +
  coord_flip()
```

# Modell for BRA. Bolig og BRA.Tot individuelt

## BRA.Bolig

```{r Modell Bolig}
options(scipen = 999)

modBolig <- "I(log(pm2)) ~ BRA.Bolig"
OLSBolig <- lm(modBolig, data = Analyse_sf)
summary(OLSBolig)
AIC(OLSBolig)
BIC(OLSBolig)
```

## BRA.Tot

```{r Modell Tot}
options(scipen = 999)

modTOT <- "I(log(pm2)) ~ BRA.Tot"
OLSTOT <- lm(modTOT, data = Analyse_sf)
summary(OLSTOT)
AIC(OLSTOT)
BIC(OLSTOT)
```

## Bruksareal.Enhet

```{r Modell Boligenhet}
options(scipen = 999)

modEnhet <- "I(log(pm2)) ~ Bruksareal.Enhet"
OLSEnhet <- lm(modEnhet, data = Analyse_sf)
summary(OLSEnhet)
AIC(OLSEnhet)
BIC(OLSEnhet)
```

# Kjører "Stepwise Regression" Analyse

```{r}
intercept_only <- lm(pm2 ~ 1, data = Blokker_sf)
```

```{r}
all <- lm(pm2 ~ EL.Kar.Original + 
  (Alder+1) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  (EiendomAreal+1) + 
  Bruksareal.Enhet + 
  EtasjeSeksjon + 
  VannkantGL + 
  VegkantGL + 
  (BebygdAreal+1) + 
  RegLBE + 
  RegGrunnforur + 
  RegKulturEiendom + 
  RegGrunnerverv + 
  RegKulturByg + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  PrivatEid + 
  HarHeis + 
  VannKode + 
  AvlopsKode + 
  BolType + 
  Kjokken + 
  YearQuarter + 
  (dist_cbd_km),
  data = Blokker_sf
)
```

```{r}
forward <- step(intercept_only, direction = 'forward', scope = formula(all), trace = 0)
```

```{r}
forward$anova
```

```{r}
forward$coefficients
```



# Forslag til modeller for videre modellkjøring, litt utifra Liv's tilbakemeldinger (Midlertidig, Åpen for forslag/endring)

**OLA: Detta e eksludert kommune. Da tar eg etter me blir enig om finalisert modell**

## Setter refferanseverdier

```{r eval=FALSE}
Analyse_sf$Kommune <- as.factor(Analyse_sf$Kommune) # Character -> Factor
Analyse_sf$Kommune <- relevel(Analyse_sf$Kommune, ref = "Alver") # Referanseverdi
```

```{r}
Analyse_sf$EL.Kar.Original <- as.factor(Analyse_sf$EL.Kar.Original) # Character -> Factor
Analyse_sf$EL.Kar.Original <- relevel(Analyse_sf$EL.Kar.Original, ref = "A") # Referanseverdi
```

```{r}
Analyse_sf$O.Karak <- as.factor(Analyse_sf$O.Karak) # Character -> Factor
Analyse_sf$O.Karak <- relevel(Analyse_sf$O.Karak, ref = "Red") # Referanseverdi
```

```{r eval=FALSE}
Blokker_sf$Kommune <- as.factor(Blokker_sf$Kommune) # Character -> Factor
Blokker_sf$Kommune <- relevel(Blokker_sf$Kommune, ref = "Alver") # Referanseverdi
```

```{r}
Blokker_sf$EL.Kar.Original <- as.factor(Blokker_sf$EL.Kar.Original) # Character -> Factor
Blokker_sf$EL.Kar.Original <- relevel(Blokker_sf$EL.Kar.Original, ref = "A") # Referanseverdi
```

```{r}
Blokker_sf$O.Karak <- as.factor(Blokker_sf$O.Karak) # Character -> Factor
Blokker_sf$O.Karak <- relevel(Blokker_sf$O.Karak, ref = "Red") # Referanseverdi
```

## Lager datasett for strømpriskrise

```{r, eval=FALSE}
Blokker_sf_Pre_Krise <- Blokker_sf %>% 
  filter(YearQuarter < "2021Q4")
```

```{r, eval=FALSE}
Blokker_sf_Etter_Krise <- Blokker_sf %>% 
  filter(YearQuarter >= "2021Q4")
```

## Lager årlige datasett

```{r, eval=FALSE}
Blokker_sf_2019 <- Blokker_sf %>% 
  filter(DokumentAr == 2019)
```

```{r, eval=FALSE}
Blokker_sf_2020 <- Blokker_sf %>% 
  filter(DokumentAr == 2020)
```

```{r, eval=FALSE}
Blokker_sf_2021 <- Blokker_sf %>% 
  filter(DokumentAr == 2021)
```

```{r, eval=FALSE}
Blokker_sf_2022 <- Blokker_sf %>% 
  filter(DokumentAr == 2022)
```

## Forslag, Modell

### Full Modell

```{r Modell_Done}
options(scipen = 999)
modBlokk <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk <- lm(modBlokk, data = Blokker_sf)
summary(OLSBlokk)
AIC(OLSBlokk)
BIC(OLSBlokk)
```

### Full Modell - Uten Oppvarmingskarakterer

### Modell, 2019

```{r Modell_Blokk_2019, eval=FALSE}
options(scipen = 999)
modBlokk_2019 <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_2019 <- lm(modBlokk_2019, data = Blokker_sf_2019)
summary(OLSBlokk_2019)
AIC(OLSBlokk_2019)
BIC(OLSBlokk_2019)
```

### Modell, 2020

```{r Modell_Blokk_2020, eval=FALSE}
options(scipen = 999)
modBlokk_2020 <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_2020 <- lm(modBlokk_2020, data = Blokker_sf_2020)
summary(OLSBlokk_2020)
AIC(OLSBlokk_2020)
BIC(OLSBlokk_2020)
```

### Modell, 2021

```{r Modell_Blokk_2021, eval=FALSE}
options(scipen = 999)
modBlokk_2021 <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_2021 <- lm(modBlokk_2021, data = Blokker_sf_2021)
summary(OLSBlokk_2021)
AIC(OLSBlokk_2021)
BIC(OLSBlokk_2021)
```

### Modell, 2022

```{r Modell_Blokk_2022, eval=FALSE}
options(scipen = 999)
modBlokk_2022 <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_2022 <- lm(modBlokk_2022, data = Blokker_sf_2022)
summary(OLSBlokk_2022)
AIC(OLSBlokk_2022)
BIC(OLSBlokk_2022)
```

### Modell, Strømpriskrise

```{r Modell_Done_Pre_Krise, eval=FALSE}
options(scipen = 999)
modBlokk_Pre_Krise <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_Pre_Krise <- lm(modBlokk_Pre_Krise, data = Blokker_sf_Pre_Krise)
summary(OLSBlokk_Pre_Krise)
AIC(OLSBlokk_Pre_Krise)
BIC(OLSBlokk_Pre_Krise)
```

```{r Modell_Done_Etter_Krise, eval=FALSE}
options(scipen = 999)
modBlokk_Etter_Krise <- "pm2 ~ 
  EL.Kar.Original + 
  (Alder) + 
  O.Karak + 
  BLEnergikWh + 
  MatValg + 
  Bruksareal.Enhet + 
  (AntallRom) + 
  (AntallBad) + 
  (AntallWC) + 
  HarHeis + 
  BolType + 
  YearQuarter +
  Kommune + 
  (dist_cbd_km)"
OLSBlokk_Etter_Krise <- lm(modBlokk_Etter_Krise, data = Blokker_sf_Etter_Krise)
summary(OLSBlokk_Etter_Krise)
AIC(OLSBlokk_Etter_Krise)
BIC(OLSBlokk_Etter_Krise)
```

# HuxReg av OLS-modeller

```{r huxreg}
#Ekje heilt oppe å går endo. Jobbe med da.

#huxreg("OLS1" = OLS1, "OLS2" = OLS2, "OLS3" = OLS3,
#       coefs = c("(Intercept)", "EL.Kar", "O.Karak_num", "MatValg_num"), #Lagt til filter på enkelte variabler
#       error_format = "[{statistic}]",
#       note = "{stars}. T statistic in brackets.")
```

# Moran's Test

## Moran's - OLS1

```{r Morans test OLS1, eval=FALSE}
lm.morantest(OLS1, Analyse_sf_W3)
lm.morantest(OLS1, Analyse_sf_W5)
lm.morantest(OLS1, Analyse_sf_W10)
```

## Moran's - OLS2

```{r Morans test OLS2, eval=FALSE}
lm.morantest(OLS2, Analyse_sf_W3)
lm.morantest(OLS2, Analyse_sf_W5)
lm.morantest(OLS2, Analyse_sf_W10)
```

## Moran's - OLS3

```{r Morans test OLS3, eval=FALSE}
lm.morantest(OLS3, Analyse_sf_W3)
lm.morantest(OLS3, Analyse_sf_W5)
lm.morantest(OLS3, Analyse_sf_W10)
```


## Moran's - OLS4

```{r Morans test OLS4, eval=FALSE}
lm.morantest(OLS4, Analyse_sf_W3)
lm.morantest(OLS4, Analyse_sf_W5)
lm.morantest(OLS4, Analyse_sf_W10)
```

## Moran's - OLS5

```{r Morans test OLS5, eval=FALSE}
lm.morantest(OLS5, Analyse_sf_W3)
lm.morantest(OLS5, Analyse_sf_W5)
lm.morantest(OLS5, Analyse_sf_W10)
```

# Kevins romlige modeller

Før vi kan kjøre de romlige modellene, må vi sjekke for multikollinearitet.

```{r}
vif_model <- lm(pm2 ~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + Kommune + dist_cbd_km, data = Analyse_sf)
```

```{r}
vif_values <- vif(vif_model)
print(vif_values)
```

# Analysen

**Har satt  eval=FALSE på alle modeller, grunna vanvittig tid og arbeid som trengs å kjøra gjennom heila dokumentet samla**


## SAR (Spatial Autoregressiv)

```{r}
Modell_Kommuner <- "pm2 ~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + Kommune + dist_cbd_km"
```

```{r}
Modell_Generell <- "pm2 ~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km"
```

### SAR-Modellene

```{r eval=FALSE}
sar_model_kommuner_k3 <- lagsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sar_model_kommuner_k10 <- lagsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sar_model_generell_k3 <- lagsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sar_model_generell_k10 <- lagsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

### Summary av SAR-modellen

```{r eval=FALSE}
cat("Summary for SAR Model - Kommuner, K3:\n")
print(summary(sar_model_kommuner_k3))
```

```{r eval=FALSE}
cat("Summary for SAR Model - Kommuner, K10:\n")
print(summary(sar_model_kommuner_k10))
```

```{r eval=FALSE}
cat("Summary for SAR Model - Generell, K3:\n")
print(summary(sar_model_generell_k3))
```

```{r eval=FALSE}
cat("Summary for SAR Model - Generell, K10:\n")
print(summary(sar_model_generell_k10))
```

## SAC (Spatial Simultaneous Autoregressiv)

### SAC-Modellane

**OLA: Trur da e Durbin = False her. Men eg finne ikkje noke konkret på Arnsteins slida, så ekje 100% sikker**

```{r eval=FALSE}
sac_model_Kommuner_K3 <- sacsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sac_model_Kommuner_K10 <- sacsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sac_model_Generell_K3 <- sacsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sac_model_Generell_K10 <- sacsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
cat("Summary for SAC Model - Kommuner, K3:\n")
print(summary(sac_model_Kommuner_K3))
```

```{r eval=FALSE}
cat("Summary for SAC Model - Kommuner, K10:\n")
print(summary(sac_model_Kommuner_K10))
```

```{r eval=FALSE}
cat("Summary for SAC Model - Generell, K3:\n")
print(summary(sac_model_Generell_K3))
```

```{r eval=FALSE}
cat("Summary for SAC Model - Generell, K10:\n")
print(summary(sac_model_Generell_K10))
```

## SEM (Spatial Error Model)

**Skifter vår noverande Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km) til --> Durbin = FALSE grunna tilbakemelding fra Liv ang. at vi ikkje skal bruke SDEM modell.**

**I følge Arnsteins slider på MSB205, så er Durbin = True/as.formula for SDEM modeller, mens Durbin = false, når vi ikkje skal bruke SDEM modell.**

Link til Arnsteins slide om SDEM og SEM for Durbin funksjon.

https://msb205.netlify.app/spatmetrics/spatreg/#/sem-model

### SEM-Modellene

```{r eval=FALSE}
sem_model_Kommuner_k3 <- errorsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sem_model_Kommuner_k10 <- errorsarlm(Modell_Kommuner,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sem_model_Generell_k3 <- errorsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W3,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

```{r eval=FALSE}
sem_model_Generell_k10 <- errorsarlm(Modell_Generell,
                      data = Analyse_sf,
                      listw = Analyse_W10,
                      Durbin = FALSE,
                      tol.solve = 1e-10)
```

### Summary av SEM-modeller

```{r eval=FALSE}
cat("Summary for SEM Model - Kommuner, K3:\n")
print(summary(sem_model_Kommuner_k3))
```

```{r eval=FALSE}
cat("Summary for SEM Model - Kommuner, K10:\n")
print(summary(sem_model_Kommuner_k10))
```

```{r eval=FALSE}
cat("Summary for SEM Model - Generell, K3:\n")
print(summary(sem_model_Generell_k3))
```

```{r eval=FALSE}
cat("Summary for SEM Model - Generell, K10:\n")
print(summary(sem_model_Generell_k10))
```

### Plot av SEM-modell

#### SEM, Kommune, K3

```{r eval=FALSE}
moran.plot(
  x = residuals(sem_model_Kommuner_k3),
  listw = Analyse_W3
)
```

#### SEM, Kommune, K10

```{r eval=FALSE}
moran.plot(
  x = residuals(sem_model_Kommuner_k10),
  listw = Analyse_W10
)
```

#### SEM, Generell, K3

```{r eval=FALSE}
moran.plot(
  x = residuals(sem_model_Generell_k3),
  listw = Analyse_W3
)
```

#### SEM, Generell, K10

```{r eval=FALSE}
moran.plot(
  x = residuals(sem_model_Generell_k10),
  listw = Analyse_W3
)
```

## SLX (Spatial lag of X-model)

### SLX-Modellene

```{r}
slx_model_kommuner_k3 <- lmSLX(Modell_Kommuner,
                                 data = Analyse_sf,
                                 listw = Analyse_W3,
                                 Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km)
                               )
```

```{r}
log_likelihood <- function(slx_model_kommuner_k3) {
  n <- length(slx_model_kommuner_k3$residuals)
  sigma2 <- sum(slx_model_kommuner_k3$residuals^2) / n
  log_likelihood <- -0.5 * n * (log(2 * pi) + log(sigma2) + 1)
  return(log_likelihood)
}

ll_value <- log_likelihood(slx_model_kommuner_k3)
print(ll_value)
```

```{r}
slx_model_kommuner_k10 <- lmSLX(Modell_Kommuner,
                                 data = Analyse_sf,
                                 listw = Analyse_W10,
                                 Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km)
                               )
```

```{r}
log_likelihood <- function(slx_model_kommuner_k10) {
  n <- length(slx_model_kommuner_k10$residuals)
  sigma2 <- sum(slx_model_kommuner_k10$residuals^2) / n
  log_likelihood <- -0.5 * n * (log(2 * pi) + log(sigma2) + 1)
  return(log_likelihood)
}

ll_value <- log_likelihood(slx_model_kommuner_k10)
print(ll_value)
```

```{r}
slx_model_generell_k3 <- lmSLX(Modell_Generell,
                                 data = Analyse_sf,
                                 listw = Analyse_W3,
                                 Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km)
                               )
```

```{r}
log_likelihood <- function(slx_model_generell_k3) {
  n <- length(slx_model_generell_k3$residuals)
  sigma2 <- sum(slx_model_generell_k3$residuals^2) / n
  log_likelihood <- -0.5 * n * (log(2 * pi) + log(sigma2) + 1)
  return(log_likelihood)
}

ll_value <- log_likelihood(slx_model_generell_k3)
print(ll_value)
```

```{r}
slx_model_generell_k10 <- lmSLX(Modell_Generell,
                                 data = Analyse_sf,
                                 listw = Analyse_W10,
                                 Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km)
                               )
```

```{r}
log_likelihood <- function(slx_model_generell_k10) {
  n <- length(slx_model_generell_k10$residuals)
  sigma2 <- sum(slx_model_generell_k10$residuals^2) / n
  log_likelihood <- -0.5 * n * (log(2 * pi) + log(sigma2) + 1)
  return(log_likelihood)
}

ll_value <- log_likelihood(slx_model_generell_k10)
print(ll_value)
```

### Summary av SLX-modeller

```{r}
cat("Summary for SLX Model - Kommuner, K3:\n")
summary(slx_model_kommuner_k3)
AIC(slx_model_kommuner_k3)
BIC(slx_model_kommuner_k3)
```

```{r}
cat("Summary for SLX Model - Kommuner, K10:\n")
summary(slx_model_kommuner_k10)
AIC(slx_model_kommuner_k10)
BIC(slx_model_kommuner_k10)
```

```{r}
cat("Summary for SLX Model - Generell, K3:\n")
summary(slx_model_generell_k3)
AIC(slx_model_generell_k3)
BIC(slx_model_generell_k3)
```

```{r}
cat("Summary for SLX Model - Generell, K10:\n")
summary(slx_model_generell_k10)
AIC(slx_model_generell_k10)
BIC(slx_model_generell_k10)
```

### Impacts, Morantest & Plot av SLX-modeller

#### SLX, Kommune, K3

```{r}
summary(impacts(slx_model_kommuner_k3), z.values = TRUE)
```

```{r}
lm.morantest(slx_model_kommuner_k3,
             listw = Analyse_W3,
             alternative = "greater",
             resfun = residuals,
             naSubset = TRUE
             )
```

```{r}
moran.plot(residuals(slx_model_kommuner_k3), listw = Analyse_W3)
```

#### SLX, Kommune, K10

```{r}
summary(impacts(slx_model_kommuner_k10), z.values = TRUE)
```

```{r}
lm.morantest(slx_model_generell_k10,
             listw = Analyse_W10,
             alternative = "greater",
             resfun = residuals,
             naSubset = TRUE
             )
```

```{r}
moran.plot(residuals(slx_model_kommuner_k10), listw = Analyse_W10)
```

#### SLX, Generell, K3

```{r}
summary(impacts(slx_model_generell_k3), z.values = TRUE)
```

```{r}
lm.morantest(slx_model_generell_k3,
             listw = Analyse_W3,
             alternative = "greater",
             resfun = residuals,
             naSubset = TRUE
             )
```

```{r}
moran.plot(residuals(slx_model_generell_k3), listw = Analyse_W3)
```

#### SLX, Generell, K10

```{r}
summary(impacts(slx_model_generell_k10), z.values = TRUE)
```

```{r}
lm.morantest(slx_model_kommuner_k10,
             listw = Analyse_W10,
             alternative = "greater",
             resfun = residuals,
             naSubset = TRUE
             )
```

```{r}
moran.plot(residuals(slx_model_generell_k10), listw = Analyse_W10)
```

```{r, eval=FALSE}
# Lager romlige laggede uavhengige variabler
X_lag <- lag.listw(Analyse_W3, as.matrix(Analyse_sf[, c("EL.Kar.Original", "Alder", "O.Karak", "BLEnergikWh", "MatValg", "Bruksareal.Enhet", "AntallRom", "AntallBad", "AntallWC", "HarHeis", "YearQuarter", "Kommune", "dist_cbd_km")]))

# Legger til romlige laggede uavhengige variabler i mitt datasett
Analyse_sf <- cbind(Analyse_sf, X_lag)
names(Analyse_sf)[(ncol(Analyse_sf) - ncol(X_lag) + 1):ncol(Analyse_sf)] <- paste0("W_", names(X_lag))

# Formulerer Spatial Durbin model med lagsarlm() med type = "mixed"
durbin_model <- lagsarlm(pm2 ~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + Kommune + dist_cbd_km, data = Analyse_sf, listw = Analyse_W3, type = "mixed")
summary(durbin_model)

```

## SDM (Spatial Durbin Modell)

### SDM-Modellene

```{r eval=FALSE}
SDM_modell_Kommuner_K3 <- lagsarlm(Modell_Kommuner,
                                   data = Analyse_sf,
                                   listw = Analyse_W3,
                                   Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km),
                                   type = "mixed")
```

```{r eval=FALSE}
SDM_modell_Kommuner_K10 <- lagsarlm(Modell_Kommuner,
                                   data = Analyse_sf,
                                   listw = Analyse_W10,
                                   Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km),
                                   type = "mixed")
```

```{r eval=FALSE}
SDM_modell_Generell_K3 <- lagsarlm(Modell_Generell,
                                   data = Analyse_sf,
                                   listw = Analyse_W3,
                                   Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km),
                                   type = "mixed")
```

```{r eval=FALSE}
SDM_modell_Generell_K10 <- lagsarlm(Modell_Generell,
                                   data = Analyse_sf,
                                   listw = Analyse_W10,
                                   Durbin = as.formula(~ EL.Kar.Original + Alder + O.Karak + BLEnergikWh + MatValg + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + HarHeis + YearQuarter + dist_cbd_km),
                                   type = "mixed")
```

### Summary av SDM-modellene

```{r eval=FALSE}
cat("Summary for SLX Model - Kommune, K3:\n")
summary(SDM_modell_Kommuner_K3)
```

```{r eval=FALSE}
cat("Summary for SLX Model - Kommune, K10:\n")
summary(SDM_modell_Kommuner_K10)
```

```{r eval=FALSE}
cat("Summary for SLX Model - Generell, K3:\n")
summary(SDM_modell_Generell_K3)
```

```{r eval=FALSE}
cat("Summary for SLX Model - Generell, K10:\n")
summary(SDM_modell_Generell_K10)
```

# Resultater (SAR/SEM/SAC/SDM)

```{r eval=FALSE}
cat("Summary for SAR model:\n")
print(summary(sar_model))

cat("\nSummary for SEM model:\n")
print(summary(sem_model))

cat("\nSummary for SAC model:\n")
print(summary(sac_model))

# cat("\nSummary for Spatial Durbin model:\n")
# print(summary(durbin_model))
```

# Tester modellene, for å finne hvilken som er mest aktuell

## Tester Kommune, K3

```{r eval=FALSE}
lmtest::lrtest(sar_model_kommuner_k3, sac_model_Kommuner_K3, sem_model_Kommuner_k3, slx_model_kommuner_k3, SDM_modell_Kommuner_K3)
```

## Tester Kommune, K10

```{r eval=FALSE}
lmtest::lrtest(sar_model_kommuner_k10, sac_model_Kommuner_K10, sem_model_Kommuner_k10, slx_model_kommuner_k10, SDM_modell_Kommuner_K10)
```

## Tester Generell, K3

```{r eval=FALSE}
lmtest::lrtest(sar_model_generell_k3, sac_model_Generell_K3, sem_model_Generell_k3, slx_model_generell_k3, SDM_modell_Generell_K3)
```

## Tester Generell, K10

```{r eval=FALSE}
lmtest::lrtest(sar_model_generell_k10, sac_model_Generell_K10, sem_model_Generell_k10, slx_model_generell_k10, SDM_modell_Generell_K10)
```

# Temp Slutt


```{r}
# Sammenligner SAR model med SEM model
lrtest_sar_vs_sem <- lrtest(sar_model, sem_model)
cat("\nLR test for SAR vs. SEM:\n")
print(lrtest_sar_vs_sem)

# Sammenligner SAR model med SAC model
lrtest_sar_vs_sac <- lrtest(sar_model, sac_model)
cat("\nLR test for SAR vs. SAC:\n")
print(lrtest_sar_vs_sac)

# Sammenligner SAR model med Spatial Durbin model
lrtest_sar_vs_durbin <- lrtest(sar_model, durbin_model)
cat("\nLR test for SAR vs. Spatial Durbin:\n")
print(lrtest_sar_vs_durbin)

# Sammenligner SEM model med SAC model
lrtest_sem_vs_sac <- lrtest(sem_model, sac_model)
cat("\nLR test for SEM vs. SAC:\n")
print(lrtest_sem_vs_sac)

# Sammenligner SEM model med Spatial Durbin model
lrtest_sem_vs_durbin <- lrtest(sem_model, durbin_model)
cat("\nLR test for SEM vs. Spatial Durbin:\n")
print(lrtest_sem_vs_durbin)

# Sammenligner SAC model med Spatial Durbin model
lrtest_sac_vs_durbin <- lrtest(sac_model, durbin_model)
cat("\nLR test for SAC vs. Spatial Durbin:\n")
print(lrtest_sac_vs_durbin)
```


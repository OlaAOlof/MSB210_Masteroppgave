---
title: "Masteroppgave"
author: 
  Kevin Ha
  Ola Andre Olofsson
format: html
editor: visual
---

# Setup Chunk

```{r setup_base}
library(readr)
library(tidyverse)
library(dplyr)
library(lubridate)
#library(zoo)
library(sf)
library(sp)
library(spdep)
library(tmap)
library(spatialreg)
#library(magrittr)
#library(measurements)
library(tibble)
library(ggcorrplot)
library(huxtable)
library(plm)
options(paged.print = FALSE)
```

# Leser inn datasettene for analyse

```{r}
Analyse <- suppressWarnings(read_csv("Datasett_Analyse.csv")) %>% 
  select(-...1)
Analyse_sf <- suppressWarnings(st_read("Datasett_Analyse_sf.gpkg"))
Analyse_Shape <- suppressWarnings(read_sf("Analyse_Shape.shp"))
```

```{r}
shp <- "Analyse_Shape.shp"
class(st_geometry(st_read(shp, quiet = TRUE, type = 3)))
```

# Summary av Datasettene

```{r}
#summary(Analyse)
summary(Analyse_sf)
```

# Lager vektmatriser

```{r}

#Kankje laga vektmatrisa på Analyse-datasettet. Må bli gjort på kart-datasettet "Analyse_sf"

#Analyse_mat_nb3 <- knearneigh(Analyse, k = 3)
#Analyse_nb3 <- knn2nb(Analyse_mat_nb3)
#Analyse_W3 <- nb2listw(Analyse_nb3, style = "W")
```

## Vektmatrise for Analyse_sf

### Tester Queen- og Rook

```{r}
queen.nb = poly2nb(Analyse_Shape)
```

```{r}
queen.listw = nb2listw(queen.nb)
```

```{r}
rook.nb = poly2nb(Analyse_Shape, queen = FALSE)
```

```{r}
rook.listw = nb2listw(rook.nb)
```

```{r}
listw1 = queen.listw
```

### Tester K-nærmeste-naboer-metoden
Her bruker vi den k-nærmeste naboer-metoden, som baserer seg på avstanden mellom punktene.
Queen- og Rook-kriteriene brukes for å definere naboer i polygondata. Queen-kriteriet sier at polygoner er naboer hvis de deler minst ett punkt (hjørne eller kant), mens Rook-kriteriet sier at polygoner er naboer hvis de deler minst en kant.

K-nærmeste naboer-metoden som brukes fremvoer fungerer for punktdata og definerer naboer basert på avstanden mellom punktene. For hver observasjon finner den k nærmeste naboene, der k er en forhåndsbestemt verdi (k = 3, k = 5 og k = 10).

#### Vektmatrise, K = 3
Oppretter romlige vektmatriser for k-nærmeste naboer med k = 3
```{r}
Analyse_sf_mat_nb3 <- knearneigh(Analyse_sf, k = 3)
Analyse_sf_nb3 <- knn2nb(Analyse_sf_mat_nb3)
Analyse_sf_W3 <- nb2listw(Analyse_sf_nb3, style = "W")
```

#### Vektmatrise, K = 5
Oppretter romlige vektmatriser for k-nærmeste naboer med k = 5
```{r}
Analyse_sf_mat_nb5 <- knearneigh(Analyse_sf, k = 5)
Analyse_sf_nb5 <- knn2nb(Analyse_sf_mat_nb5)
Analyse_sf_W5 <- nb2listw(Analyse_sf_nb5, style = "W")
```

#### Vektmatrise, K = 10
Oppretter romlige vektmatriser for k-nærmeste naboer med k = 10
```{r}
Analyse_sf_mat_nb10 <- knearneigh(Analyse_sf, k = 10)
Analyse_sf_nb10 <- knn2nb(Analyse_sf_mat_nb10)
Analyse_sf_W10 <- nb2listw(Analyse_sf_nb10, style = "W")
```

# Kevin test

```{r}
# Nå plotter vi punktene og naboene for et utvalg av punkter for å se om det ser ut som om de har riktig antall naboer (k = 10).
plot(st_geometry(Analyse_sf), pch = 19, cex = 0.5, col = "blue")

# Velg et punkt for å se naboene
point_index <- 1

# Plot de valgte pointsene og naboene
plot(Analyse_sf[point_index, ], col = "red", pch = 19, cex = 1.2, add = TRUE)
plot(Analyse_sf[names(Analyse_sf_nb10[[point_index]]), ], col = "green", pch = 19, cex = 10, add = TRUE)

# Legger til beskrivelse
legend("bottomright", legend = c("Points", "Selected point", "Naboer (k = 10)"),
       col = c("blue", "red", "green"), pch = 19, cex = 0.8)
```

```{r Kevins Moran}
# Definer en variabel for romlig analyse
Pris <- Analyse_sf$P

# Beregn Global Moran's I for k = 3, k = 5 og k = 10
moran_3 <- moran.test(Pris, Analyse_sf_W3)
moran_5 <- moran.test(Pris, Analyse_sf_W5)
moran_10 <- moran.test(Pris, Analyse_sf_W10)

# Vis resultater
cat("Global Moran's I (k = 3):", moran_3$estimate, "\n")
cat("Global Moran's I (k = 5):", moran_5$estimate, "\n")
cat("Global Moran's I (k = 10):", moran_10$estimate, "\n")
```
Disse resultatene viser Global Moran's I-verdier for k = 3, k = 5 og k = 10. Global Moran's I er et mål på romlig autokorrelasjon som gir en indikasjon på hvordan en variabel (i dette tilfellet "Pris") er korrelert med seg selv i rommet. I dette tilfellet er variabelen "Pris" korrelert med sine nærmeste naboer.

Resultatene viser følgende:
Global Moran's I (k = 3): 0.3930968
Global Moran's I (k = 5): 0.3361125
Global Moran's I (k = 10): 0.2473997
Global Moran's I-verdier varierer mellom -1 og 1:

Verdier nær 1 indikerer positiv romlig autokorrelasjon, der lignende verdier er gruppert sammen i rommet.
Verdier nær -1 indikerer negativ romlig autokorrelasjon, der ulike verdier er gruppert sammen i rommet.
Verdier nær 0 indikerer ingen romlig autokorrelasjon, der verdier er jevnt fordelt i rommet.
I dette tilfellet er alle Global Moran's I-verdier positive, noe som tyder på positiv romlig autokorrelasjon. Det betyr at høyere priser har en tendens til å være nærmere hverandre, og lavere priser har en tendens til å være nærmere hverandre i rommet.

Det er viktig å merke seg at Moran's I-verdien avtar når antall naboer (k) øker. Dette kan skyldes at når flere naboer inkluderes i analysen, blir det mindre sannsynlig at hver enhet har naboer med lignende verdier.

Tallene etter Moran's I-verdiene i resultatene (-0.0003374958 og 0.0001646533 for k = 3, osv.) er konstantleddet og koeffisienten for x i Moran's I-beregningen. Disse tallene brukes for å beregne Moran's I-verdien og er ikke av stor interesse for tolkningen av resultatene.

```{r Kevins modell}
# Konverter Analyse_sf til en pdata.frame for romlig regresjon
analyse_sf_pdata <- pdata.frame(Analyse_sf)

# Definer modellformel
Kev_model <- "P ~ Alder + EL.Kar + Bruksareal.Enhet + dist_cbd_km"

# Utfør romlig regresjon (lagmodell) for k = 3, k = 5 og k = 10
lag_model_3 <- lagsarlm(Kev_model, data = Analyse_sf, listw = Analyse_sf_W3)
lag_model_5 <- lagsarlm(Kev_model, data = Analyse_sf, listw = Analyse_sf_W5)
lag_model_10 <- lagsarlm(Kev_model, data = Analyse_sf, listw = Analyse_sf_W10)

# Vis resultater fra modellene
summary(lag_model_3)
summary(lag_model_5)
summary(lag_model_10)
```


# Lager modeller


## Modell 1

```{r}
mod1 <- "P ~ EL.Kar + O.Karak + MatValg"
```

## Modell 2

Punkt 2: Vi må finne ut kva variablar vi må ha "ln" framfor og kva variablar vi skal ha "I" framfor for å beholde formatering.

```{r}
#Fant problemet: Kan ikkje ta variabel BRA.Annet i SF_datasett, grunna alle verdiane e 0
mod2 <- "P ~ Alder + BLEnergikWh + Oms.Typ + BolType + AntEiendom + EiendomAreal + VannkantGL + VegkantGL + RegLBE + RegGrunnforur + RegKulturEiendom + RegGrunnerverv + RegBoDrivePlikt + TotBoliger + BRA.Bolig + BRA.Tot + BebygdAreal + RegKulturByg + Etasje + Lopenr + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + PrivatEid + HarHeis + EtasjeSeksjon + Kjokken + VannKode + AvlopsKode + YearQuarter"
```

## Modell 3

Punkt 2: Vi må finne ut kva variablar vi må ha "ln" framfor og kva variablar vi skal ha "I" framfor for å beholde formatering.

```{r}
mod3 <- "P ~ Alder + EL.Kar + O.Karak + BLEnergikWh + MatValg + Oms.Typ + BolType + AntEiendom + EiendomAreal + VannkantGL + VegkantGL + RegLBE + RegGrunnforur + RegKulturEiendom + RegGrunnerverv + RegBoDrivePlikt + TotBoliger + BRA.Bolig + BRA.Tot + BebygdAreal + RegKulturByg + Etasje + Lopenr + Bruksareal.Enhet + AntallRom + AntallBad + AntallWC + PrivatEid + HarHeis + EtasjeSeksjon + Kjokken + VannKode + AvlopsKode + YearQuarter + dist_cbd_km"
```

## Modell 4

```{r}
mod4 <- "P ~ EL.Kar"
```

# Kjører OLS-Modellen på våres modeller

## OLS1

```{r}
OLS1 = lm(mod1, data = Analyse_sf)
```

```{r}
summary(OLS1)
```

## OLS2

Punkt 2: Vi må finne ut kva variablar vi må ha "ln" framfor og kva variablar vi skal ha "I" framfor for å beholde formatering.

```{r}
OLS2 = lm(mod2, data = Analyse_sf)
```

```{r}
summary(OLS2)
```

## OLS3

Punkt 2: Vi må finne ut kva variablar vi må ha "ln" framfor og kva variablar vi skal ha "I" framfor for å beholde formatering.

```{r}
OLS3 = lm(mod3, data = Analyse_sf)
```

```{r}
summary(OLS3)
```

## OLS4

```{r}
#OLS4 = lm(mod4, data = Analyse_sf)
```

```{r}
#summary(OLS4)
```

# HuxReg av OLS-modeller

```{r}
#Ekje heilt oppe å går endo. Jobbe med da.

#huxreg("OLS1" = OLS1, "OLS2" = OLS2, "OLS3" = OLS3,
#       error_format = "[{statistic}]",
#       note = "{stars}. T statistic in brackets.")
```

# Moran's Test

## Moran's - OLS1

```{r}
lm.morantest(OLS1, Analyse_sf_W3)
```

```{r}
lm.morantest(OLS1, Analyse_sf_W5)
```

```{r}
lm.morantest(OLS1, Analyse_sf_W10)
```

## Moran's - OLS2

```{r}
lm.morantest(OLS2, Analyse_sf_W3)
```

```{r}
lm.morantest(OLS2, Analyse_sf_W5)
```

```{r}
lm.morantest(OLS2, Analyse_sf_W10)
```

## Moran's - OLS3

```{r}
lm.morantest(OLS3, Analyse_sf_W3)
```

```{r}
lm.morantest(OLS3, Analyse_sf_W5)
```

```{r}
lm.morantest(OLS3, Analyse_sf_W10)
```

## Moran's OLS4

```{r}
cor_matrix <- cor(Analyse_sf[c("P", "EL.Kar", "Alder", "B.Ar", "Etasje", "AntallRom")])

ggcorrplot(cor_matrix)
```

```{r}
correlation <- cor(Analyse_sf$B.Ar, Analyse$AntallRom, method = "pearson")

#print(correlation)
```

```{r}
cor_matrix <- cor(Analyse_sf[c("P", "EL.Kar", "Alder", "Etasje", "AntallRom")])

ggcorrplot(cor_matrix, type = "lower", hc.order = TRUE, lab = TRUE)
```

```{r}
#Siste
```
